import { Args, CLValueParser, Conversions, ExecutionResult, InfoGetDeployResultV1Compatible, InfoGetTransactionResultV1Compatible, } from 'casper-js-sdk';
import { NetworkMajorVersion } from '../types/types';
import { convertTransactionArgsToObj } from "./cltype";
import { deriveSplitDataFromNamedKeyValue } from "./named-key";
import { isNonNullable, isObject, uniq } from "./guards";
export const getExecutionResultsFromDeployRawData = (deployRawData) => {
    if (!deployRawData)
        return null;
    const networkVersionFromRawData = (deployRawData.api_version && deployRawData.api_version.startsWith('1')
        ? NetworkMajorVersion.V1
        : NetworkMajorVersion.V2) || NetworkMajorVersion.V2;
    if (networkVersionFromRawData === '1') {
        const transactionData = InfoGetDeployResultV1Compatible.fromJSON(deployRawData);
        return transactionData?.executionResults &&
            transactionData?.executionResults[0]
            ? ExecutionResult.fromV1(transactionData.executionResults?.[0].result)
            : null;
    }
    const transactionData = InfoGetTransactionResultV1Compatible.fromJSON(deployRawData);
    return transactionData?.executionInfo
        ? transactionData.executionInfo.executionResult
        : null;
};
export const deriveUpdatedAssociatedKey = (deployRawData) => {
    const executionResult = getExecutionResultsFromDeployRawData(deployRawData);
    const transforms = executionResult?.effects ?? [];
    const writeAccountDeployInfo = transforms.filter((obj) => obj.kind.isWriteAccount());
    const writeAccountTransform = writeAccountDeployInfo?.length > 0 ? writeAccountDeployInfo[0] : null;
    return writeAccountTransform?.kind?.parseAsWriteAccount().toPrefixedString();
};
export function getWasmProxyArguments(args) {
    const clValue = CLValueParser.toJSON(args);
    return convertTransactionArgsToObj(Args.fromBytes(Conversions.decodeBase16(clValue.bytes.substring(8))));
}
export function getWasmProxyArgumentsFromRawData(argumentsFromRawData) {
    const wasmArgs = argumentsFromRawData.args.args.get('args');
    if (!wasmArgs)
        return null;
    try {
        return getWasmProxyArguments(wasmArgs);
    }
    catch (e) {
        console.error('getWasmProxyArgumentsFromRawData', e);
        return null;
    }
}
;
export const deriveHashListByKeysFromObject = (data, keys) => {
    const result = [];
    if (!data) {
        return null;
    }
    data.forEach((obj) => {
        keys.forEach(key => {
            if (key in obj && obj[key] !== null && obj[key] !== undefined) {
                const hash = obj[key];
                if (hash) {
                    const { hash: hashWithoutPrefix } = deriveSplitDataFromNamedKeyValue(hash);
                    result.push(hashWithoutPrefix);
                }
            }
        });
    });
    return result.length > 0 ? result.filter(isNonNullable) : null;
};
/**
 * Considers only `parsed` field of the object `args`
 * @param data
 * @param keys
 */
export const deriveHashListByKeysFromDeployArgsObject = (data, keys) => {
    const result = [];
    if (!data) {
        return null;
    }
    const uniqKeys = uniq(keys);
    data.forEach((obj) => {
        uniqKeys.forEach(key => {
            if (key in obj.args &&
                obj.args[key] !== null &&
                obj.args[key] !== undefined) {
                if (Array.isArray(obj.args[key].parsed)) {
                    return;
                }
                const hash = isObject(obj.args[key].parsed)
                    ? Object.values(obj.args[key].parsed)[0]
                    : obj.args[key].parsed;
                if (hash) {
                    const { hash: hashWithoutPrefix } = deriveSplitDataFromNamedKeyValue(hash);
                    result.push(hashWithoutPrefix);
                }
            }
        });
    });
    return result.length > 0 ? result.filter(isNonNullable) : null;
};
export const MapDeploy = ({ deploy_hash, block_hash, caller_public_key, contract_hash, contract_package_hash, error_message, payment_amount, contract_entrypoint, contract_package, execution_type_id, nft_token_actions, ft_token_actions, account_info, centralized_account_info, rate, caller_cspr_name, caller_hash, consumed_gas, refund_amount, block_height, ...rest }) => {
    return {
        ...rest,
        accountInfo: account_info,
        blockHash: block_hash,
        blockHeight: block_height,
        callerCsprName: caller_cspr_name,
        callerHash: caller_hash,
        callerPublicKey: caller_public_key,
        centralizedAccountInfo: centralized_account_info,
        consumedGas: consumed_gas,
        contractHash: contract_hash,
        contractPackage: contract_package,
        contractPackageHash: contract_package_hash,
        deployHash: deploy_hash,
        entryPoint: contract_entrypoint,
        errorMessage: error_message,
        executionTypeId: execution_type_id,
        ftActions: ft_token_actions,
        nftActions: nft_token_actions,
        paymentAmount: payment_amount,
        refundAmount: refund_amount,
        timeTransactionCurrencyRate: rate,
    };
};
export const MapPaginatedDeploys = ({ data, ...rest }) => {
    return {
        ...rest,
        data: data ? data.map(MapDeploy) : [],
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95LWFjdGlvbi1oZWxwZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi91dGlscy9kZXBsb3ktYWN0aW9uLWhlbHBlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLElBQUksRUFDSixhQUFhLEVBQ2IsV0FBVyxFQUNYLGVBQWUsRUFFZiwrQkFBK0IsRUFDL0Isb0NBQW9DLEdBQ3JDLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBd0MsbUJBQW1CLEVBQW9CLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0csT0FBTyxFQUFDLDJCQUEyQixFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3JELE9BQU8sRUFBQyxnQ0FBZ0MsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUM3RCxPQUFPLEVBQUMsYUFBYSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFFdkQsTUFBTSxDQUFDLE1BQU0sb0NBQW9DLEdBQUcsQ0FDaEQsYUFBK0IsRUFDVCxFQUFFO0lBQzFCLElBQUksQ0FBQyxhQUFhO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDaEMsTUFBTSx5QkFBeUIsR0FDM0IsQ0FBQyxhQUFhLENBQUMsV0FBVyxJQUFJLGFBQWEsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQztRQUNuRSxDQUFDLENBQUMsbUJBQW1CLENBQUMsRUFBRTtRQUN4QixDQUFDLENBQUMsbUJBQW1CLENBQUMsRUFBRSxDQUFDLElBQUksbUJBQW1CLENBQUMsRUFBRSxDQUFDO0lBRTVELElBQUkseUJBQXlCLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDdEMsTUFBTSxlQUFlLEdBQ2pCLCtCQUErQixDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUU1RCxPQUFPLGVBQWUsRUFBRSxnQkFBZ0I7WUFDeEMsZUFBZSxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztZQUNoQyxDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDdEUsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxNQUFNLGVBQWUsR0FDakIsb0NBQW9DLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRWpFLE9BQU8sZUFBZSxFQUFFLGFBQWE7UUFDakMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsZUFBZTtRQUMvQyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2IsQ0FBQyxDQUFDO0FBR0YsTUFBTSxDQUFDLE1BQU0sMEJBQTBCLEdBQUcsQ0FDeEMsYUFBMEMsRUFDdEIsRUFBRTtJQUN0QixNQUFNLGVBQWUsR0FDbkIsb0NBQW9DLENBQUMsYUFBYSxDQUFDLENBQUM7SUFFdEQsTUFBTSxVQUFVLEdBQUcsZUFBZSxFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFFbEQsTUFBTSxzQkFBc0IsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBYyxFQUFFLEVBQUUsQ0FDbEUsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FDMUIsQ0FBQztJQUVGLE1BQU0scUJBQXFCLEdBQ3pCLHNCQUFzQixFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFFeEUsT0FBTyxxQkFBcUIsRUFBRSxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0FBQy9FLENBQUMsQ0FBQztBQUVGLE1BQU0sVUFBVSxxQkFBcUIsQ0FBQyxJQUFJO0lBQ3hDLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFM0MsT0FBTywyQkFBMkIsQ0FDaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDckUsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLFVBQVUsZ0NBQWdDLENBQUMsb0JBQW9CO0lBQ25FLE1BQU0sUUFBUSxHQUFHLG9CQUFvQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRTVELElBQUksQ0FBQyxRQUFRO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFFM0IsSUFBSSxDQUFDO1FBQ0gsT0FBTyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztRQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQztBQUFBLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSw4QkFBOEIsR0FBRyxDQUFDLElBQVMsRUFBRSxJQUFjLEVBQUUsRUFBRTtJQUMxRSxNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7SUFDNUIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1YsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFO1FBQ3hCLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDakIsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUM5RCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFXLENBQUM7Z0JBRWhDLElBQUksSUFBSSxFQUFFLENBQUM7b0JBQ1QsTUFBTSxFQUFFLElBQUksRUFBRSxpQkFBaUIsRUFBRSxHQUM3QixnQ0FBZ0MsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDM0MsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2dCQUNqQyxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDakUsQ0FBQyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLHdDQUF3QyxHQUFHLENBQ3BELElBQVMsRUFDVCxJQUFjLEVBQ2hCLEVBQUU7SUFDRixNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7SUFFNUIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1YsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTVCLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRTtRQUN4QixRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3JCLElBQ0ksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJO2dCQUNmLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSTtnQkFDdEIsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxTQUFTLEVBQzdCLENBQUM7Z0JBQ0QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztvQkFDeEMsT0FBTztnQkFDVCxDQUFDO2dCQUVELE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztvQkFDdkMsQ0FBQyxDQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQVk7b0JBQ3BELENBQUMsQ0FBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQWlCLENBQUM7Z0JBRXZDLElBQUksSUFBSSxFQUFFLENBQUM7b0JBQ1QsTUFBTSxFQUFFLElBQUksRUFBRSxpQkFBaUIsRUFBRSxHQUM3QixnQ0FBZ0MsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDM0MsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2dCQUNqQyxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDakUsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLENBQUMsRUFDeEIsV0FBVyxFQUNYLFVBQVUsRUFDVixpQkFBaUIsRUFDakIsYUFBYSxFQUNiLHFCQUFxQixFQUNyQixhQUFhLEVBQ2IsY0FBYyxFQUNkLG1CQUFtQixFQUNuQixnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLGlCQUFpQixFQUNqQixnQkFBZ0IsRUFDaEIsWUFBWSxFQUNaLHdCQUF3QixFQUN4QixJQUFJLEVBQ0osZ0JBQWdCLEVBQ2hCLFdBQVcsRUFDWCxZQUFZLEVBQ1osYUFBYSxFQUNiLFlBQVksRUFDWixHQUFHLElBQUksRUFDTSxFQUFVLEVBQUU7SUFDekIsT0FBTztRQUNMLEdBQUcsSUFBSTtRQUNQLFdBQVcsRUFBRSxZQUFZO1FBQ3pCLFNBQVMsRUFBRSxVQUFVO1FBQ3JCLFdBQVcsRUFBRSxZQUFZO1FBQ3pCLGNBQWMsRUFBRSxnQkFBZ0I7UUFDaEMsVUFBVSxFQUFFLFdBQVc7UUFDdkIsZUFBZSxFQUFFLGlCQUFpQjtRQUNsQyxzQkFBc0IsRUFBRSx3QkFBd0I7UUFDaEQsV0FBVyxFQUFFLFlBQVk7UUFDekIsWUFBWSxFQUFFLGFBQWE7UUFDM0IsZUFBZSxFQUFFLGdCQUFnQjtRQUNqQyxtQkFBbUIsRUFBRSxxQkFBcUI7UUFDMUMsVUFBVSxFQUFFLFdBQVc7UUFDdkIsVUFBVSxFQUFFLG1CQUFtQjtRQUMvQixZQUFZLEVBQUUsYUFBYTtRQUMzQixlQUFlLEVBQUUsaUJBQWlCO1FBQ2xDLFNBQVMsRUFBRSxnQkFBZ0I7UUFDM0IsVUFBVSxFQUFFLGlCQUFpQjtRQUM3QixhQUFhLEVBQUUsY0FBYztRQUM3QixZQUFZLEVBQUUsYUFBYTtRQUMzQiwyQkFBMkIsRUFBRSxJQUFJO0tBQ2xDLENBQUM7QUFDSixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLEVBQ0UsSUFBSSxFQUNKLEdBQUcsSUFBSSxFQUN5QixFQUE2QixFQUFFO0lBQ25HLE9BQU87UUFDTCxHQUFHLElBQUk7UUFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO0tBQ3RDLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBcmdzLFxuICBDTFZhbHVlUGFyc2VyLFxuICBDb252ZXJzaW9ucyxcbiAgRXhlY3V0aW9uUmVzdWx0LFxuICBUcmFuc2Zvcm0sXG4gIEluZm9HZXREZXBsb3lSZXN1bHRWMUNvbXBhdGlibGUsXG4gIEluZm9HZXRUcmFuc2FjdGlvblJlc3VsdFYxQ29tcGF0aWJsZSxcbn0gZnJvbSAnY2FzcGVyLWpzLXNkayc7XG5pbXBvcnQge0RlcGxveSwgRGVwbG95UmVzdWx0LCBHZXREZXBsb3lSZXN1bHQsIE5ldHdvcmtNYWpvclZlcnNpb24sIFBhZ2luYXRlZFJlc3BvbnNlfSBmcm9tICcuLi90eXBlcy90eXBlcyc7XG5pbXBvcnQge2NvbnZlcnRUcmFuc2FjdGlvbkFyZ3NUb09ian0gZnJvbSBcIi4vY2x0eXBlXCI7XG5pbXBvcnQge2Rlcml2ZVNwbGl0RGF0YUZyb21OYW1lZEtleVZhbHVlfSBmcm9tIFwiLi9uYW1lZC1rZXlcIjtcbmltcG9ydCB7aXNOb25OdWxsYWJsZSwgaXNPYmplY3QsIHVuaXF9IGZyb20gXCIuL2d1YXJkc1wiO1xuXG5leHBvcnQgY29uc3QgZ2V0RXhlY3V0aW9uUmVzdWx0c0Zyb21EZXBsb3lSYXdEYXRhID0gKFxuICAgIGRlcGxveVJhd0RhdGE/OiBHZXREZXBsb3lSZXN1bHQsXG4pOiBFeGVjdXRpb25SZXN1bHQgfCBudWxsID0+IHtcbiAgaWYgKCFkZXBsb3lSYXdEYXRhKSByZXR1cm4gbnVsbDtcbiAgY29uc3QgbmV0d29ya1ZlcnNpb25Gcm9tUmF3RGF0YSA9XG4gICAgICAoZGVwbG95UmF3RGF0YS5hcGlfdmVyc2lvbiAmJiBkZXBsb3lSYXdEYXRhLmFwaV92ZXJzaW9uLnN0YXJ0c1dpdGgoJzEnKVxuICAgICAgICAgID8gTmV0d29ya01ham9yVmVyc2lvbi5WMVxuICAgICAgICAgIDogTmV0d29ya01ham9yVmVyc2lvbi5WMikgfHwgTmV0d29ya01ham9yVmVyc2lvbi5WMjtcblxuICBpZiAobmV0d29ya1ZlcnNpb25Gcm9tUmF3RGF0YSA9PT0gJzEnKSB7XG4gICAgY29uc3QgdHJhbnNhY3Rpb25EYXRhID1cbiAgICAgICAgSW5mb0dldERlcGxveVJlc3VsdFYxQ29tcGF0aWJsZS5mcm9tSlNPTihkZXBsb3lSYXdEYXRhKTtcblxuICAgIHJldHVybiB0cmFuc2FjdGlvbkRhdGE/LmV4ZWN1dGlvblJlc3VsdHMgJiZcbiAgICB0cmFuc2FjdGlvbkRhdGE/LmV4ZWN1dGlvblJlc3VsdHNbMF1cbiAgICAgICAgPyBFeGVjdXRpb25SZXN1bHQuZnJvbVYxKHRyYW5zYWN0aW9uRGF0YS5leGVjdXRpb25SZXN1bHRzPy5bMF0ucmVzdWx0KVxuICAgICAgICA6IG51bGw7XG4gIH1cblxuICBjb25zdCB0cmFuc2FjdGlvbkRhdGEgPVxuICAgICAgSW5mb0dldFRyYW5zYWN0aW9uUmVzdWx0VjFDb21wYXRpYmxlLmZyb21KU09OKGRlcGxveVJhd0RhdGEpO1xuXG4gIHJldHVybiB0cmFuc2FjdGlvbkRhdGE/LmV4ZWN1dGlvbkluZm9cbiAgICAgID8gdHJhbnNhY3Rpb25EYXRhLmV4ZWN1dGlvbkluZm8uZXhlY3V0aW9uUmVzdWx0XG4gICAgICA6IG51bGw7XG59O1xuXG5cbmV4cG9ydCBjb25zdCBkZXJpdmVVcGRhdGVkQXNzb2NpYXRlZEtleSA9IChcbiAgZGVwbG95UmF3RGF0YTogR2V0RGVwbG95UmVzdWx0IHwgdW5kZWZpbmVkLFxuKTogc3RyaW5nIHwgdW5kZWZpbmVkID0+IHtcbiAgY29uc3QgZXhlY3V0aW9uUmVzdWx0OiBFeGVjdXRpb25SZXN1bHQgfCBudWxsID1cbiAgICBnZXRFeGVjdXRpb25SZXN1bHRzRnJvbURlcGxveVJhd0RhdGEoZGVwbG95UmF3RGF0YSk7XG5cbiAgY29uc3QgdHJhbnNmb3JtcyA9IGV4ZWN1dGlvblJlc3VsdD8uZWZmZWN0cyA/PyBbXTtcblxuICBjb25zdCB3cml0ZUFjY291bnREZXBsb3lJbmZvID0gdHJhbnNmb3Jtcy5maWx0ZXIoKG9iajogVHJhbnNmb3JtKSA9PlxuICAgIG9iai5raW5kLmlzV3JpdGVBY2NvdW50KCksXG4gICk7XG5cbiAgY29uc3Qgd3JpdGVBY2NvdW50VHJhbnNmb3JtID1cbiAgICB3cml0ZUFjY291bnREZXBsb3lJbmZvPy5sZW5ndGggPiAwID8gd3JpdGVBY2NvdW50RGVwbG95SW5mb1swXSA6IG51bGw7XG5cbiAgcmV0dXJuIHdyaXRlQWNjb3VudFRyYW5zZm9ybT8ua2luZD8ucGFyc2VBc1dyaXRlQWNjb3VudCgpLnRvUHJlZml4ZWRTdHJpbmcoKTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRXYXNtUHJveHlBcmd1bWVudHMoYXJncykge1xuICBjb25zdCBjbFZhbHVlID0gQ0xWYWx1ZVBhcnNlci50b0pTT04oYXJncyk7XG5cbiAgcmV0dXJuIGNvbnZlcnRUcmFuc2FjdGlvbkFyZ3NUb09iaihcbiAgICBBcmdzLmZyb21CeXRlcyhDb252ZXJzaW9ucy5kZWNvZGVCYXNlMTYoY2xWYWx1ZS5ieXRlcy5zdWJzdHJpbmcoOCkpKSxcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdhc21Qcm94eUFyZ3VtZW50c0Zyb21SYXdEYXRhKGFyZ3VtZW50c0Zyb21SYXdEYXRhKSB7XG4gIGNvbnN0IHdhc21BcmdzID0gYXJndW1lbnRzRnJvbVJhd0RhdGEuYXJncy5hcmdzLmdldCgnYXJncycpO1xuXG4gIGlmICghd2FzbUFyZ3MpIHJldHVybiBudWxsO1xuXG4gIHRyeSB7XG4gICAgcmV0dXJuIGdldFdhc21Qcm94eUFyZ3VtZW50cyh3YXNtQXJncyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmVycm9yKCdnZXRXYXNtUHJveHlBcmd1bWVudHNGcm9tUmF3RGF0YScsIGUpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZGVyaXZlSGFzaExpc3RCeUtleXNGcm9tT2JqZWN0ID0gKGRhdGE6IGFueSwga2V5czogc3RyaW5nW10pID0+IHtcbiAgY29uc3QgcmVzdWx0OiBzdHJpbmdbXSA9IFtdO1xuICBpZiAoIWRhdGEpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGRhdGEuZm9yRWFjaCgob2JqOiBhbnkpID0+IHtcbiAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmIChrZXkgaW4gb2JqICYmIG9ialtrZXldICE9PSBudWxsICYmIG9ialtrZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29uc3QgaGFzaCA9IG9ialtrZXldIGFzIHN0cmluZztcblxuICAgICAgICBpZiAoaGFzaCkge1xuICAgICAgICAgIGNvbnN0IHsgaGFzaDogaGFzaFdpdGhvdXRQcmVmaXggfSA9XG4gICAgICAgICAgICAgIGRlcml2ZVNwbGl0RGF0YUZyb21OYW1lZEtleVZhbHVlKGhhc2gpO1xuICAgICAgICAgIHJlc3VsdC5wdXNoKGhhc2hXaXRob3V0UHJlZml4KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA+IDAgPyByZXN1bHQuZmlsdGVyKGlzTm9uTnVsbGFibGUpIDogbnVsbDtcbn07XG5cbi8qKlxuICogQ29uc2lkZXJzIG9ubHkgYHBhcnNlZGAgZmllbGQgb2YgdGhlIG9iamVjdCBgYXJnc2BcbiAqIEBwYXJhbSBkYXRhXG4gKiBAcGFyYW0ga2V5c1xuICovXG5leHBvcnQgY29uc3QgZGVyaXZlSGFzaExpc3RCeUtleXNGcm9tRGVwbG95QXJnc09iamVjdCA9IChcbiAgICBkYXRhOiBhbnksXG4gICAga2V5czogc3RyaW5nW11cbikgPT4ge1xuICBjb25zdCByZXN1bHQ6IHN0cmluZ1tdID0gW107XG5cbiAgaWYgKCFkYXRhKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCB1bmlxS2V5cyA9IHVuaXEoa2V5cyk7XG5cbiAgZGF0YS5mb3JFYWNoKChvYmo6IGFueSkgPT4ge1xuICAgIHVuaXFLZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmIChcbiAgICAgICAgICBrZXkgaW4gb2JqLmFyZ3MgJiZcbiAgICAgICAgICBvYmouYXJnc1trZXldICE9PSBudWxsICYmXG4gICAgICAgICAgb2JqLmFyZ3Nba2V5XSAhPT0gdW5kZWZpbmVkXG4gICAgICApIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqLmFyZ3Nba2V5XS5wYXJzZWQpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgaGFzaCA9IGlzT2JqZWN0KG9iai5hcmdzW2tleV0ucGFyc2VkKVxuICAgICAgICAgICAgPyAoT2JqZWN0LnZhbHVlcyhvYmouYXJnc1trZXldLnBhcnNlZClbMF0gYXMgc3RyaW5nKVxuICAgICAgICAgICAgOiAob2JqLmFyZ3Nba2V5XS5wYXJzZWQgYXMgc3RyaW5nKTtcblxuICAgICAgICBpZiAoaGFzaCkge1xuICAgICAgICAgIGNvbnN0IHsgaGFzaDogaGFzaFdpdGhvdXRQcmVmaXggfSA9XG4gICAgICAgICAgICAgIGRlcml2ZVNwbGl0RGF0YUZyb21OYW1lZEtleVZhbHVlKGhhc2gpO1xuICAgICAgICAgIHJlc3VsdC5wdXNoKGhhc2hXaXRob3V0UHJlZml4KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA+IDAgPyByZXN1bHQuZmlsdGVyKGlzTm9uTnVsbGFibGUpIDogbnVsbDtcbn07XG5cbmV4cG9ydCBjb25zdCBNYXBEZXBsb3kgPSAoe1xuICBkZXBsb3lfaGFzaCxcbiAgYmxvY2tfaGFzaCxcbiAgY2FsbGVyX3B1YmxpY19rZXksXG4gIGNvbnRyYWN0X2hhc2gsXG4gIGNvbnRyYWN0X3BhY2thZ2VfaGFzaCxcbiAgZXJyb3JfbWVzc2FnZSxcbiAgcGF5bWVudF9hbW91bnQsXG4gIGNvbnRyYWN0X2VudHJ5cG9pbnQsXG4gIGNvbnRyYWN0X3BhY2thZ2UsXG4gIGV4ZWN1dGlvbl90eXBlX2lkLFxuICBuZnRfdG9rZW5fYWN0aW9ucyxcbiAgZnRfdG9rZW5fYWN0aW9ucyxcbiAgYWNjb3VudF9pbmZvLFxuICBjZW50cmFsaXplZF9hY2NvdW50X2luZm8sXG4gIHJhdGUsXG4gIGNhbGxlcl9jc3ByX25hbWUsXG4gIGNhbGxlcl9oYXNoLFxuICBjb25zdW1lZF9nYXMsXG4gIHJlZnVuZF9hbW91bnQsXG4gIGJsb2NrX2hlaWdodCxcbiAgLi4ucmVzdFxufTogRGVwbG95UmVzdWx0KTogRGVwbG95ID0+IHtcbiAgcmV0dXJuIHtcbiAgICAuLi5yZXN0LFxuICAgIGFjY291bnRJbmZvOiBhY2NvdW50X2luZm8sXG4gICAgYmxvY2tIYXNoOiBibG9ja19oYXNoLFxuICAgIGJsb2NrSGVpZ2h0OiBibG9ja19oZWlnaHQsXG4gICAgY2FsbGVyQ3Nwck5hbWU6IGNhbGxlcl9jc3ByX25hbWUsXG4gICAgY2FsbGVySGFzaDogY2FsbGVyX2hhc2gsXG4gICAgY2FsbGVyUHVibGljS2V5OiBjYWxsZXJfcHVibGljX2tleSxcbiAgICBjZW50cmFsaXplZEFjY291bnRJbmZvOiBjZW50cmFsaXplZF9hY2NvdW50X2luZm8sXG4gICAgY29uc3VtZWRHYXM6IGNvbnN1bWVkX2dhcyxcbiAgICBjb250cmFjdEhhc2g6IGNvbnRyYWN0X2hhc2gsXG4gICAgY29udHJhY3RQYWNrYWdlOiBjb250cmFjdF9wYWNrYWdlLFxuICAgIGNvbnRyYWN0UGFja2FnZUhhc2g6IGNvbnRyYWN0X3BhY2thZ2VfaGFzaCxcbiAgICBkZXBsb3lIYXNoOiBkZXBsb3lfaGFzaCxcbiAgICBlbnRyeVBvaW50OiBjb250cmFjdF9lbnRyeXBvaW50LFxuICAgIGVycm9yTWVzc2FnZTogZXJyb3JfbWVzc2FnZSxcbiAgICBleGVjdXRpb25UeXBlSWQ6IGV4ZWN1dGlvbl90eXBlX2lkLFxuICAgIGZ0QWN0aW9uczogZnRfdG9rZW5fYWN0aW9ucyxcbiAgICBuZnRBY3Rpb25zOiBuZnRfdG9rZW5fYWN0aW9ucyxcbiAgICBwYXltZW50QW1vdW50OiBwYXltZW50X2Ftb3VudCxcbiAgICByZWZ1bmRBbW91bnQ6IHJlZnVuZF9hbW91bnQsXG4gICAgdGltZVRyYW5zYWN0aW9uQ3VycmVuY3lSYXRlOiByYXRlLFxuICB9O1xufTtcblxuZXhwb3J0IGNvbnN0IE1hcFBhZ2luYXRlZERlcGxveXMgPSAoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OiBQYWdpbmF0ZWRSZXNwb25zZTxEZXBsb3lSZXN1bHQ+KTogUGFnaW5hdGVkUmVzcG9uc2U8RGVwbG95PiA9PiB7XG4gIHJldHVybiB7XG4gICAgLi4ucmVzdCxcbiAgICBkYXRhOiBkYXRhID8gZGF0YS5tYXAoTWFwRGVwbG95KSA6IFtdLFxuICB9O1xufTsiXX0=