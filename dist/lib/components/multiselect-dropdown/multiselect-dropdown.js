import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useState, useEffect } from 'react';
import styled from 'styled-components';
import { useMultipleSelection, useCombobox } from 'downshift';
import { useClickAndTouchAway } from '../../hooks/use-click-and-touch-away';
import FlexRow from '../flex-row/flex-row';
import FlexColumn from '../flex-column/flex-column';
import BodyText from '../body-text/body-text';
import SvgIcon from '../svg-icon/svg-icon';
import Input from '../input/input';
import { ArrowDownIcon, DeleteIcon, SearchIcon } from '../../icons-index';
const DropdownContainer = styled.div(({ theme, disabled }) => ({
    outline: 'none',
    ...(disabled && {
        opacity: '0.5',
        pointerEvents: 'none',
    }),
}));
const MultiSelectContainer = styled(FlexRow)(({ theme }) => ({
    borderRadius: theme.borderRadius.base,
    padding: '8px',
    background: theme.styleguideColors.fillSecondary,
    ':hover, :active': {
        svg: {
            color: theme.styleguideColors.fillPrimaryRed,
        },
    },
}));
const InputContainer = styled(FlexRow)(({ theme }) => ({
    width: '100%',
}));
const StyledInput = styled(Input)(() => ({
    width: '100%',
    border: 'none',
    height: '24px',
    '> div': {
        padding: '0 8px',
    },
}));
const DropdownIconWrapper = styled(FlexRow)(({ theme }) => ({
    paddingRight: '8px',
    marginLeft: '8px',
}));
const ArrowSvgIcon = styled(SvgIcon)(({ theme }) => ({
    path: {
        fill: theme.styleguideColors.contentPrimary,
    },
}));
const ClearSvgIcon = styled(SvgIcon)(({ theme }) => ({
    path: {
        stroke: theme.styleguideColors.contentPrimary,
    },
}));
const ChipItemContainer = styled.span(({ theme }) => ({
    borderRadius: theme.borderRadius.base,
    cursor: 'pointer',
    padding: '2px 8px',
    background: theme.styleguideColors.fillTertiary,
    color: theme.styleguideColors.contentPrimary,
    wordBreak: 'break-word',
}));
const ItemsContainer = styled.div(({ theme, isOpen }) => ({
    display: isOpen ? 'inherit' : 'none',
    marginTop: 4,
    borderRadius: theme.borderRadius.base,
    background: theme.styleguideColors.fillSecondary,
    maxHeight: '250px',
    overflowY: 'scroll',
}));
const ItemsContainerEmpty = styled(FlexRow)(({ theme }) => ({
    padding: '32px 16px',
    pointerEvents: 'none',
    justifyContent: 'center',
}));
const ItemContainer = styled(FlexRow)(({ theme }) => ({
    cursor: 'pointer',
    minHeight: 36,
    padding: '8px 16px',
    wordBreak: 'break-word',
    ':hover, :active': {
        background: theme.styleguideColors.fillSecondaryBlueHover,
        fontWeight: 600,
    },
}));
const MultiSelectDeleteIcon = styled(SvgIcon)(({ theme }) => ({
    path: {
        stroke: theme.styleguideColors.contentBlue,
    },
    ':hover, :active': {
        path: {
            stroke: theme.styleguideColors.contentRed,
        },
    },
}));
const getChangeEvent = (value) => {
    return {
        target: {
            name: undefined,
            value,
        },
    };
};
export function MultiselectDropdown(props) {
    const { items, value, label, placeholder, disabled = false, onSelectItem, onAddItem, onRemoveItem, onChangeInput, } = props;
    const [inputValue, setInputValue] = useState('');
    const { getSelectedItemProps, getDropdownProps, addSelectedItem, removeSelectedItem, selectedItems, setSelectedItems, reset, } = useMultipleSelection({
        initialSelectedItems: value,
        onSelectedItemsChange: (changes) => {
            onSelectItem && onSelectItem(getChangeEvent(changes.selectedItems));
        },
    });
    const inputValueItem = inputValue?.length >= 3
        ? [
            {
                id: inputValue,
                label: inputValue,
                value: inputValue,
                chipLabel: inputValue,
            },
        ]
        : [];
    const itemsWithCustomInputValue = [...inputValueItem, ...items];
    const { isOpen, getToggleButtonProps, getLabelProps, getMenuProps, getInputProps, getItemProps, openMenu, } = useCombobox({
        inputValue,
        items: itemsWithCustomInputValue,
        onStateChange: ({ inputValue, type, selectedItem: newSelectedItem }) => {
            switch (type) {
                case useCombobox.stateChangeTypes.InputChange:
                    setInputValue(inputValue || '');
                    onChangeInput && onChangeInput(inputValue || '');
                    break;
                case useCombobox.stateChangeTypes.InputKeyDownEnter:
                case useCombobox.stateChangeTypes.ItemClick:
                case useCombobox.stateChangeTypes.InputBlur:
                    const isAlreadySelected = selectedItems.some((i) => i.value === newSelectedItem?.value);
                    if (newSelectedItem) {
                        if (isAlreadySelected) {
                            setSelectedItems(selectedItems.filter((i) => i.value !== newSelectedItem.value));
                            onRemoveItem && onRemoveItem(getChangeEvent(newSelectedItem));
                        }
                        else {
                            addSelectedItem(newSelectedItem);
                            onAddItem && onAddItem(getChangeEvent(newSelectedItem));
                        }
                    }
                    break;
                case useCombobox.stateChangeTypes.FunctionCloseMenu:
                    handleClearInput();
                    break;
                default:
                    break;
            }
        },
        stateReducer: (state, actionAndChanges) => {
            const { changes, type } = actionAndChanges;
            switch (type) {
                case useCombobox.stateChangeTypes.InputKeyDownEnter:
                case useCombobox.stateChangeTypes.ItemClick:
                    return {
                        ...changes,
                        isOpen: state.isOpen, // keep the menu open after selection.
                    };
                default:
                    return changes;
            }
        },
    });
    const { ref: outerClickRef } = useClickAndTouchAway({
        callback: () => {
            if (isOpen) {
                handleClearInput();
            }
        },
    });
    //Align resetting selected values if they were reset in parent
    useEffect(() => {
        if (!value || value.length < 1) {
            reset();
        }
    }, [value]);
    const handleClearInput = () => {
        setInputValue('');
        onChangeInput && onChangeInput('');
    };
    const handleClearAll = () => {
        handleClearInput();
        onSelectItem && onSelectItem(getChangeEvent(null));
        reset();
    };
    const showInput = isOpen || selectedItems.length === 0;
    return (_jsx(DropdownContainer, { disabled: disabled, ref: outerClickRef, children: _jsxs(FlexColumn, { itemsSpacing: 4, children: [label && (_jsx(BodyText, { lineHeight: 'xs', ...getLabelProps(), size: 1, children: label })), _jsxs("div", { children: [_jsxs(MultiSelectContainer, { isOpen: isOpen, align: "center", justify: "space-between", ...getToggleButtonProps(getDropdownProps({ preventKeyAction: isOpen })), children: [_jsxs(InputContainer, { gap: 8, wrap: 'wrap', children: [selectedItems.map((selectedItem, index) => (_jsx(ChipItemContainer, { ...getSelectedItemProps({ selectedItem, index }), children: _jsx(BodyText, { lineHeight: 'xs', size: 3, variation: selectedItem ? 'inherit' : 'darkGray', children: _jsxs(FlexRow, { align: 'center', gap: 4, children: [selectedItem?.chipLabel || selectedItem?.label, _jsx(MultiSelectDeleteIcon, { onClick: (event) => {
                                                                event.preventDefault();
                                                                event.stopPropagation();
                                                                removeSelectedItem(selectedItem);
                                                            }, size: 14, src: DeleteIcon })] }) }) }, `selected-item-${index}`))), showInput ? (_jsx(StyledInput, { ...getInputProps({
                                                placeholder,
                                                value: inputValue || '',
                                                disabled,
                                                onFocus() {
                                                    openMenu();
                                                },
                                            }, { suppressRefError: true }), prefixIcon: _jsx(SvgIcon, { src: SearchIcon }) })) : null] }), _jsxs(DropdownIconWrapper, { children: [!!selectedItems.length && (_jsx(ClearSvgIcon, { src: DeleteIcon, onClick: handleClearAll, marginRight: true })), _jsx(ArrowSvgIcon, { src: ArrowDownIcon, rotate: isOpen })] })] }), _jsx(ItemsContainer, { ...getMenuProps(), isOpen: isOpen, children: isOpen &&
                                (!(itemsWithCustomInputValue && itemsWithCustomInputValue.length) ? (_jsx(ItemsContainerEmpty, { children: _jsx(BodyText, { size: 3, lineHeight: 'xs', scale: 'xs', children: "No items found" }) })) : (itemsWithCustomInputValue.map((item, index) => (_jsx(ItemContainer, { align: "center", justify: "space-between", itemsSpacing: 10, ...getItemProps({
                                        item,
                                        index,
                                        'aria-selected': selectedItems.includes(item),
                                    }), children: _jsx(BodyText, { size: 3, lineHeight: 'xs', scale: 'xs', children: item.label }) }, `${item.value}${index}`))))) })] })] }) }));
}
export default MultiselectDropdown;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlzZWxlY3QtZHJvcGRvd24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NvbXBvbmVudHMvbXVsdGlzZWxlY3QtZHJvcGRvd24vbXVsdGlzZWxlY3QtZHJvcGRvd24udHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFjLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUNuRCxPQUFPLE1BQU0sTUFBTSxtQkFBbUIsQ0FBQztBQUN2QyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzVFLE9BQU8sT0FBTyxNQUFNLHNCQUFzQixDQUFDO0FBQzNDLE9BQU8sVUFBVSxNQUFNLDRCQUE0QixDQUFDO0FBQ3BELE9BQU8sUUFBUSxNQUFNLHdCQUF3QixDQUFDO0FBRTlDLE9BQU8sT0FBTyxNQUFNLHNCQUFzQixDQUFDO0FBQzNDLE9BQU8sS0FBSyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTFFLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FDbEMsQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN4QixPQUFPLEVBQUUsTUFBTTtJQUVmLEdBQUcsQ0FBQyxRQUFRLElBQUk7UUFDZCxPQUFPLEVBQUUsS0FBSztRQUNkLGFBQWEsRUFBRSxNQUFNO0tBQ3RCLENBQUM7Q0FDSCxDQUFDLENBQ0gsQ0FBQztBQUVGLE1BQU0sb0JBQW9CLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUMxQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDZCxZQUFZLEVBQUUs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dkIsWUFBWSxFQUFFLEVBQUUsS0FFWixZQUFZLENBQUM7d0NBQ2YsSUFBSTt3Q0FDSixLQUFLO3dDQUNMLGVBQWUsRUFBRSxhQUFhLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztxQ0FDOUMsQ0FBQyxZQUVGLEtBQUMsUUFBUSxJQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxZQUM3QyxJQUFJLENBQUMsS0FBSyxHQUNGLElBVE4sR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssRUFBRSxDQVVkLENBQ2pCLENBQ0YsQ0FDRixDQUFDLEdBQ1csSUFDYixJQUNLLEdBQ0ssQ0FDckIsQ0FBQztBQUNKLENBQUM7QUFFRCxlQUFlLG1CQUFtQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZVN0YXRlLCB1c2VFZmZlY3QgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc3R5bGVkIGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJztcbmltcG9ydCB7IHVzZU11bHRpcGxlU2VsZWN0aW9uLCB1c2VDb21ib2JveCB9IGZyb20gJ2Rvd25zaGlmdCc7XG5pbXBvcnQgeyB1c2VDbGlja0FuZFRvdWNoQXdheSB9IGZyb20gJy4uLy4uL2hvb2tzL3VzZS1jbGljay1hbmQtdG91Y2gtYXdheSc7XG5pbXBvcnQgRmxleFJvdyBmcm9tICcuLi9mbGV4LXJvdy9mbGV4LXJvdyc7XG5pbXBvcnQgRmxleENvbHVtbiBmcm9tICcuLi9mbGV4LWNvbHVtbi9mbGV4LWNvbHVtbic7XG5pbXBvcnQgQm9keVRleHQgZnJvbSAnLi4vYm9keS10ZXh0L2JvZHktdGV4dCc7XG5pbXBvcnQgeyBCYXNlUHJvcHMgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5pbXBvcnQgU3ZnSWNvbiBmcm9tICcuLi9zdmctaWNvbi9zdmctaWNvbic7XG5pbXBvcnQgSW5wdXQgZnJvbSAnLi4vaW5wdXQvaW5wdXQnO1xuaW1wb3J0IHsgQXJyb3dEb3duSWNvbiwgRGVsZXRlSWNvbiwgU2VhcmNoSWNvbiB9IGZyb20gJy4uLy4uL2ljb25zLWluZGV4JztcblxuY29uc3QgRHJvcGRvd25Db250YWluZXIgPSBzdHlsZWQuZGl2PHsgZGlzYWJsZWQ/OiBib29sZWFuIH0+KFxuICAoeyB0aGVtZSwgZGlzYWJsZWQgfSkgPT4gKHtcbiAgICBvdXRsaW5lOiAnbm9uZScsXG5cbiAgICAuLi4oZGlzYWJsZWQgJiYge1xuICAgICAgb3BhY2l0eTogJzAuNScsXG4gICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsXG4gICAgfSksXG4gIH0pLFxuKTtcblxuY29uc3QgTXVsdGlTZWxlY3RDb250YWluZXIgPSBzdHlsZWQoRmxleFJvdyk8eyBpc09wZW46IGJvb2xlYW4gfT4oXG4gICh7IHRoZW1lIH0pID0+ICh7XG4gICAgYm9yZGVyUmFkaXVzOiB0aGVtZS5ib3JkZXJSYWRpdXMuYmFzZSxcbiAgICBwYWRkaW5nOiAnOHB4JyxcbiAgICBiYWNrZ3JvdW5kOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmZpbGxTZWNvbmRhcnksXG4gICAgJzpob3ZlciwgOmFjdGl2ZSc6IHtcbiAgICAgIHN2Zzoge1xuICAgICAgICBjb2xvcjogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5maWxsUHJpbWFyeVJlZCxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSksXG4pO1xuXG5jb25zdCBJbnB1dENvbnRhaW5lciA9IHN0eWxlZChGbGV4Um93KSgoeyB0aGVtZSB9KSA9PiAoe1xuICB3aWR0aDogJzEwMCUnLFxufSkpO1xuXG5jb25zdCBTdHlsZWRJbnB1dCA9IHN0eWxlZChJbnB1dCkoKCkgPT4gKHtcbiAgd2lkdGg6ICcxMDAlJyxcbiAgYm9yZGVyOiAnbm9uZScsXG4gIGhlaWdodDogJzI0cHgnLFxuICAnPiBkaXYnOiB7XG4gICAgcGFkZGluZzogJzAgOHB4JyxcbiAgfSxcbn0pKTtcblxuY29uc3QgRHJvcGRvd25JY29uV3JhcHBlciA9IHN0eWxlZChGbGV4Um93KSgoeyB0aGVtZSB9KSA9PiAoe1xuICBwYWRkaW5nUmlnaHQ6ICc4cHgnLFxuICBtYXJnaW5MZWZ0OiAnOHB4Jyxcbn0pKTtcblxuY29uc3QgQXJyb3dTdmdJY29uID0gc3R5bGVkKFN2Z0ljb24pKCh7IHRoZW1lIH0pID0+ICh7XG4gIHBhdGg6IHtcbiAgICBmaWxsOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmNvbnRlbnRQcmltYXJ5LFxuICB9LFxufSkpO1xuXG5jb25zdCBDbGVhclN2Z0ljb24gPSBzdHlsZWQoU3ZnSWNvbikoKHsgdGhlbWUgfSkgPT4gKHtcbiAgcGF0aDoge1xuICAgIHN0cm9rZTogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5jb250ZW50UHJpbWFyeSxcbiAgfSxcbn0pKTtcblxuY29uc3QgQ2hpcEl0ZW1Db250YWluZXIgPSBzdHlsZWQuc3BhbigoeyB0aGVtZSB9KSA9PiAoe1xuICBib3JkZXJSYWRpdXM6IHRoZW1lLmJvcmRlclJhZGl1cy5iYXNlLFxuICBjdXJzb3I6ICdwb2ludGVyJyxcbiAgcGFkZGluZzogJzJweCA4cHgnLFxuICBiYWNrZ3JvdW5kOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmZpbGxUZXJ0aWFyeSxcbiAgY29sb3I6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuY29udGVudFByaW1hcnksXG4gIHdvcmRCcmVhazogJ2JyZWFrLXdvcmQnLFxufSkpO1xuXG5jb25zdCBJdGVtc0NvbnRhaW5lciA9IHN0eWxlZC5kaXY8eyBpc09wZW46IGJvb2xlYW4gfT4oKHsgdGhlbWUsIGlzT3BlbiB9KSA9PiAoe1xuICBkaXNwbGF5OiBpc09wZW4gPyAnaW5oZXJpdCcgOiAnbm9uZScsXG4gIG1hcmdpblRvcDogNCxcbiAgYm9yZGVyUmFkaXVzOiB0aGVtZS5ib3JkZXJSYWRpdXMuYmFzZSxcbiAgYmFja2dyb3VuZDogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5maWxsU2Vjb25kYXJ5LFxuICBtYXhIZWlnaHQ6ICcyNTBweCcsXG4gIG92ZXJmbG93WTogJ3Njcm9sbCcsXG59KSk7XG5cbmNvbnN0IEl0ZW1zQ29udGFpbmVyRW1wdHkgPSBzdHlsZWQoRmxleFJvdykoKHsgdGhlbWUgfSkgPT4gKHtcbiAgcGFkZGluZzogJzMycHggMTZweCcsXG4gIHBvaW50ZXJFdmVudHM6ICdub25lJyxcbiAganVzdGlmeUNvbnRlbnQ6ICdjZW50ZXInLFxufSkpO1xuXG5jb25zdCBJdGVtQ29udGFpbmVyID0gc3R5bGVkKEZsZXhSb3cpKCh7IHRoZW1lIH0pID0+ICh7XG4gIGN1cnNvcjogJ3BvaW50ZXInLFxuICBtaW5IZWlnaHQ6IDM2LFxuICBwYWRkaW5nOiAnOHB4IDE2cHgnLFxuICB3b3JkQnJlYWs6ICdicmVhay13b3JkJyxcbiAgJzpob3ZlciwgOmFjdGl2ZSc6IHtcbiAgICBiYWNrZ3JvdW5kOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmZpbGxTZWNvbmRhcnlCbHVlSG92ZXIsXG4gICAgZm9udFdlaWdodDogNjAwLFxuICB9LFxufSkpO1xuXG5jb25zdCBNdWx0aVNlbGVjdERlbGV0ZUljb24gPSBzdHlsZWQoU3ZnSWNvbikoKHsgdGhlbWUgfSkgPT4gKHtcbiAgcGF0aDoge1xuICAgIHN0cm9rZTogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5jb250ZW50Qmx1ZSxcbiAgfSxcbiAgJzpob3ZlciwgOmFjdGl2ZSc6IHtcbiAgICBwYXRoOiB7XG4gICAgICBzdHJva2U6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuY29udGVudFJlZCxcbiAgICB9LFxuICB9LFxufSkpO1xuXG5leHBvcnQgdHlwZSBNdWx0aVNlbGVjdERyb3Bkb3duVmFsdWUgPSB7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIGNoaXBMYWJlbD86IHN0cmluZztcbiAgdmFsdWU6IGFueTtcbn07XG5cbmV4cG9ydCB0eXBlIE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlID0ge1xuICB0YXJnZXQ6IHtcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHZhbHVlOiBNdWx0aVNlbGVjdERyb3Bkb3duVmFsdWUgfCBudWxsO1xuICB9O1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBNdWx0aVNlbGVjdElucHV0UHJvcHMgZXh0ZW5kcyBCYXNlUHJvcHMge1xuICB2YWx1ZT86IE11bHRpU2VsZWN0RHJvcGRvd25WYWx1ZVtdO1xuICBpdGVtczogTXVsdGlTZWxlY3REcm9wZG93blZhbHVlW107XG4gIGxhYmVsPzogc3RyaW5nIHwgSlNYLkVsZW1lbnQ7XG4gIHBsYWNlaG9sZGVyPzogc3RyaW5nO1xuICBkaXNhYmxlZD86IGJvb2xlYW47XG4gIG9uQWRkSXRlbT86IChldjogTXVsdGlTZWxlY3REcm9wZG93bkV2ZW50VmFsdWUpID0+IHZvaWQ7XG4gIG9uU2VsZWN0SXRlbT86IChldjogTXVsdGlTZWxlY3REcm9wZG93bkV2ZW50VmFsdWUpID0+IHZvaWQ7XG4gIG9uUmVtb3ZlSXRlbT86IChldjogTXVsdGlTZWxlY3REcm9wZG93bkV2ZW50VmFsdWUpID0+IHZvaWQ7XG4gIG9uQ2hhbmdlSW5wdXQ/OiAodmFsdWU6IHN0cmluZykgPT4gdm9pZDtcbn1cblxuY29uc3QgZ2V0Q2hhbmdlRXZlbnQgPSAodmFsdWU6IGFueSk6IE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlID0+IHtcbiAgcmV0dXJuIHtcbiAgICB0YXJnZXQ6IHtcbiAgICAgIG5hbWU6IHVuZGVmaW5lZCxcbiAgICAgIHZhbHVlLFxuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gTXVsdGlzZWxlY3REcm9wZG93bihwcm9wczogTXVsdGlTZWxlY3RJbnB1dFByb3BzKSB7XG4gIGNvbnN0IHtcbiAgICBpdGVtcyxcbiAgICB2YWx1ZSxcbiAgICBsYWJlbCxcbiAgICBwbGFjZWhvbGRlcixcbiAgICBkaXNhYmxlZCA9IGZhbHNlLFxuICAgIG9uU2VsZWN0SXRlbSxcbiAgICBvbkFkZEl0ZW0sXG4gICAgb25SZW1vdmVJdGVtLFxuICAgIG9uQ2hhbmdlSW5wdXQsXG4gIH0gPSBwcm9wcztcbiAgY29uc3QgW2lucHV0VmFsdWUsIHNldElucHV0VmFsdWVdID0gdXNlU3RhdGU8c3RyaW5nPignJyk7XG5cbiAgY29uc3Qge1xuICAgIGdldFNlbGVjdGVkSXRlbVByb3BzLFxuICAgIGdldERyb3Bkb3duUHJvcHMsXG4gICAgYWRkU2VsZWN0ZWRJdGVtLFxuICAgIHJlbW92ZVNlbGVjdGVkSXRlbSxcbiAgICBzZWxlY3RlZEl0ZW1zLFxuICAgIHNldFNlbGVjdGVkSXRlbXMsXG4gICAgcmVzZXQsXG4gIH0gPSB1c2VNdWx0aXBsZVNlbGVjdGlvbjxNdWx0aVNlbGVjdERyb3Bkb3duVmFsdWU+KHtcbiAgICBpbml0aWFsU2VsZWN0ZWRJdGVtczogdmFsdWUsXG4gICAgb25TZWxlY3RlZEl0ZW1zQ2hhbmdlOiAoY2hhbmdlcykgPT4ge1xuICAgICAgb25TZWxlY3RJdGVtICYmIG9uU2VsZWN0SXRlbShnZXRDaGFuZ2VFdmVudChjaGFuZ2VzLnNlbGVjdGVkSXRlbXMpKTtcbiAgICB9LFxuICB9KTtcblxuICBjb25zdCBpbnB1dFZhbHVlSXRlbSA9XG4gICAgaW5wdXRWYWx1ZT8ubGVuZ3RoID49IDNcbiAgICAgID8gW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiBpbnB1dFZhbHVlLFxuICAgICAgICAgICAgbGFiZWw6IGlucHV0VmFsdWUsXG4gICAgICAgICAgICB2YWx1ZTogaW5wdXRWYWx1ZSxcbiAgICAgICAgICAgIGNoaXBMYWJlbDogaW5wdXRWYWx1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICBdXG4gICAgICA6IFtdO1xuXG4gIGNvbnN0IGl0ZW1zV2l0aEN1c3RvbUlucHV0VmFsdWUgPSBbLi4uaW5wdXRWYWx1ZUl0ZW0sIC4uLml0ZW1zXTtcblxuICBjb25zdCB7XG4gICAgaXNPcGVuLFxuICAgIGdldFRvZ2dsZUJ1dHRvblByb3BzLFxuICAgIGdldExhYmVsUHJvcHMsXG4gICAgZ2V0TWVudVByb3BzLFxuICAgIGdldElucHV0UHJvcHMsXG4gICAgZ2V0SXRlbVByb3BzLFxuICAgIG9wZW5NZW51LFxuICB9ID0gdXNlQ29tYm9ib3g8TXVsdGlTZWxlY3REcm9wZG93blZhbHVlPih7XG4gICAgaW5wdXRWYWx1ZSxcbiAgICBpdGVtczogaXRlbXNXaXRoQ3VzdG9tSW5wdXRWYWx1ZSxcbiAgICBvblN0YXRlQ2hhbmdlOiAoeyBpbnB1dFZhbHVlLCB0eXBlLCBzZWxlY3RlZEl0ZW06IG5ld1NlbGVjdGVkSXRlbSB9KSA9PiB7XG4gICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLklucHV0Q2hhbmdlOlxuICAgICAgICAgIHNldElucHV0VmFsdWUoaW5wdXRWYWx1ZSB8fCAnJyk7XG4gICAgICAgICAgb25DaGFuZ2VJbnB1dCAmJiBvbkNoYW5nZUlucHV0KGlucHV0VmFsdWUgfHwgJycpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgdXNlQ29tYm9ib3guc3RhdGVDaGFuZ2VUeXBlcy5JbnB1dEtleURvd25FbnRlcjpcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLkl0ZW1DbGljazpcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLklucHV0Qmx1cjpcbiAgICAgICAgICBjb25zdCBpc0FscmVhZHlTZWxlY3RlZCA9IHNlbGVjdGVkSXRlbXMuc29tZShcbiAgICAgICAgICAgIChpKSA9PiBpLnZhbHVlID09PSBuZXdTZWxlY3RlZEl0ZW0/LnZhbHVlLFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAobmV3U2VsZWN0ZWRJdGVtKSB7XG4gICAgICAgICAgICBpZiAoaXNBbHJlYWR5U2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRJdGVtcyhcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1zLmZpbHRlcigoaSkgPT4gaS52YWx1ZSAhPT0gbmV3U2VsZWN0ZWRJdGVtLnZhbHVlKSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgb25SZW1vdmVJdGVtICYmIG9uUmVtb3ZlSXRlbShnZXRDaGFuZ2VFdmVudChuZXdTZWxlY3RlZEl0ZW0pKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGFkZFNlbGVjdGVkSXRlbShuZXdTZWxlY3RlZEl0ZW0pO1xuICAgICAgICAgICAgICBvbkFkZEl0ZW0gJiYgb25BZGRJdGVtKGdldENoYW5nZUV2ZW50KG5ld1NlbGVjdGVkSXRlbSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLkZ1bmN0aW9uQ2xvc2VNZW51OlxuICAgICAgICAgIGhhbmRsZUNsZWFySW5wdXQoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9LFxuICAgIHN0YXRlUmVkdWNlcjogKHN0YXRlLCBhY3Rpb25BbmRDaGFuZ2VzKSA9PiB7XG4gICAgICBjb25zdCB7IGNoYW5nZXMsIHR5cGUgfSA9IGFjdGlvbkFuZENoYW5nZXM7XG4gICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLklucHV0S2V5RG93bkVudGVyOlxuICAgICAgICBjYXNlIHVzZUNvbWJvYm94LnN0YXRlQ2hhbmdlVHlwZXMuSXRlbUNsaWNrOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5jaGFuZ2VzLFxuICAgICAgICAgICAgaXNPcGVuOiBzdGF0ZS5pc09wZW4sIC8vIGtlZXAgdGhlIG1lbnUgb3BlbiBhZnRlciBzZWxlY3Rpb24uXG4gICAgICAgICAgfTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gY2hhbmdlcztcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcblxuICBjb25zdCB7IHJlZjogb3V0ZXJDbGlja1JlZiB9ID0gdXNlQ2xpY2tBbmRUb3VjaEF3YXkoe1xuICAgIGNhbGxiYWNrOiAoKSA9PiB7XG4gICAgICBpZiAoaXNPcGVuKSB7XG4gICAgICAgIGhhbmRsZUNsZWFySW5wdXQoKTtcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcblxuICAvL0FsaWduIHJlc2V0dGluZyBzZWxlY3RlZCB2YWx1ZXMgaWYgdGhleSB3ZXJlIHJlc2V0IGluIHBhcmVudFxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmICghdmFsdWUgfHwgdmFsdWUubGVuZ3RoIDwgMSkge1xuICAgICAgcmVzZXQoKTtcbiAgICB9XG4gIH0sIFt2YWx1ZV0pO1xuXG4gIGNvbnN0IGhhbmRsZUNsZWFySW5wdXQgPSAoKSA9PiB7XG4gICAgc2V0SW5wdXRWYWx1ZSgnJyk7XG4gICAgb25DaGFuZ2VJbnB1dCAmJiBvbkNoYW5nZUlucHV0KCcnKTtcbiAgfTtcblxuICBjb25zdCBoYW5kbGVDbGVhckFsbCA9ICgpID0+IHtcbiAgICBoYW5kbGVDbGVhcklucHV0KCk7XG4gICAgb25TZWxlY3RJdGVtICYmIG9uU2VsZWN0SXRlbShnZXRDaGFuZ2VFdmVudChudWxsKSk7XG4gICAgcmVzZXQoKTtcbiAgfTtcblxuICBjb25zdCBzaG93SW5wdXQgPSBpc09wZW4gfHwgc2VsZWN0ZWRJdGVtcy5sZW5ndGggPT09IDA7XG5cbiAgcmV0dXJuIChcbiAgICA8RHJvcGRvd25Db250YWluZXIgZGlzYWJsZWQ9e2Rpc2FibGVkfSByZWY9e291dGVyQ2xpY2tSZWZ9PlxuICAgICAgPEZsZXhDb2x1bW4gaXRlbXNTcGFjaW5nPXs0fT5cbiAgICAgICAge2xhYmVsICYmIChcbiAgICAgICAgICA8Qm9keVRleHQgbGluZUhlaWdodD17J3hzJ30gey4uLmdldExhYmVsUHJvcHMoKX0gc2l6ZT17MX0+XG4gICAgICAgICAgICB7bGFiZWx9XG4gICAgICAgICAgPC9Cb2R5VGV4dD5cbiAgICAgICAgKX1cbiAgICAgICAgPGRpdj5cbiAgICAgICAgICA8TXVsdGlTZWxlY3RDb250YWluZXJcbiAgICAgICAgICAgIGlzT3Blbj17aXNPcGVufVxuICAgICAgICAgICAgYWxpZ249XCJjZW50ZXJcIlxuICAgICAgICAgICAganVzdGlmeT1cInNwYWNlLWJldHdlZW5cIlxuICAgICAgICAgICAgey4uLmdldFRvZ2dsZUJ1dHRvblByb3BzKFxuICAgICAgICAgICAgICBnZXREcm9wZG93blByb3BzKHsgcHJldmVudEtleUFjdGlvbjogaXNPcGVuIH0pLFxuICAgICAgICAgICAgKX1cbiAgICAgICAgICA+XG4gICAgICAgICAgICA8SW5wdXRDb250YWluZXIgZ2FwPXs4fSB3cmFwPXsnd3JhcCd9PlxuICAgICAgICAgICAgICB7c2VsZWN0ZWRJdGVtcy5tYXAoKHNlbGVjdGVkSXRlbSwgaW5kZXgpID0+IChcbiAgICAgICAgICAgICAgICA8Q2hpcEl0ZW1Db250YWluZXJcbiAgICAgICAgICAgICAgICAgIGtleT17YHNlbGVjdGVkLWl0ZW0tJHtpbmRleH1gfVxuICAgICAgICAgICAgICAgICAgey4uLmdldFNlbGVjdGVkSXRlbVByb3BzKHsgc2VsZWN0ZWRJdGVtLCBpbmRleCB9KX1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICA8Qm9keVRleHRcbiAgICAgICAgICAgICAgICAgICAgbGluZUhlaWdodD17J3hzJ31cbiAgICAgICAgICAgICAgICAgICAgc2l6ZT17M31cbiAgICAgICAgICAgICAgICAgICAgdmFyaWF0aW9uPXtzZWxlY3RlZEl0ZW0gPyAnaW5oZXJpdCcgOiAnZGFya0dyYXknfVxuICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8RmxleFJvdyBhbGlnbj17J2NlbnRlcid9IGdhcD17NH0+XG4gICAgICAgICAgICAgICAgICAgICAge3NlbGVjdGVkSXRlbT8uY2hpcExhYmVsIHx8IHNlbGVjdGVkSXRlbT8ubGFiZWx9XG4gICAgICAgICAgICAgICAgICAgICAgPE11bHRpU2VsZWN0RGVsZXRlSWNvblxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVTZWxlY3RlZEl0ZW0oc2VsZWN0ZWRJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICAgICAgICBzaXplPXsxNH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHNyYz17RGVsZXRlSWNvbn1cbiAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICA8L0ZsZXhSb3c+XG4gICAgICAgICAgICAgICAgICA8L0JvZHlUZXh0PlxuICAgICAgICAgICAgICAgIDwvQ2hpcEl0ZW1Db250YWluZXI+XG4gICAgICAgICAgICAgICkpfVxuICAgICAgICAgICAgICB7c2hvd0lucHV0ID8gKFxuICAgICAgICAgICAgICAgIDxTdHlsZWRJbnB1dFxuICAgICAgICAgICAgICAgICAgey4uLmdldElucHV0UHJvcHMoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaW5wdXRWYWx1ZSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZCxcbiAgICAgICAgICAgICAgICAgICAgICBvbkZvY3VzKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3Blbk1lbnUoKTtcbiAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7IHN1cHByZXNzUmVmRXJyb3I6IHRydWUgfSxcbiAgICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgICAgICBwcmVmaXhJY29uPXs8U3ZnSWNvbiBzcmM9e1NlYXJjaEljb259IC8+fVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICkgOiBudWxsfVxuICAgICAgICAgICAgPC9JbnB1dENvbnRhaW5lcj5cbiAgICAgICAgICAgIDxEcm9wZG93bkljb25XcmFwcGVyPlxuICAgICAgICAgICAgICB7ISFzZWxlY3RlZEl0ZW1zLmxlbmd0aCAmJiAoXG4gICAgICAgICAgICAgICAgPENsZWFyU3ZnSWNvblxuICAgICAgICAgICAgICAgICAgc3JjPXtEZWxldGVJY29ufVxuICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlQ2xlYXJBbGx9XG4gICAgICAgICAgICAgICAgICBtYXJnaW5SaWdodFxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgIDxBcnJvd1N2Z0ljb24gc3JjPXtBcnJvd0Rvd25JY29ufSByb3RhdGU9e2lzT3Blbn0gLz5cbiAgICAgICAgICAgIDwvRHJvcGRvd25JY29uV3JhcHBlcj5cbiAgICAgICAgICA8L011bHRpU2VsZWN0Q29udGFpbmVyPlxuICAgICAgICAgIDxJdGVtc0NvbnRhaW5lciB7Li4uZ2V0TWVudVByb3BzKCl9IGlzT3Blbj17aXNPcGVufT5cbiAgICAgICAgICAgIHtpc09wZW4gJiZcbiAgICAgICAgICAgICAgKCEoXG4gICAgICAgICAgICAgICAgaXRlbXNXaXRoQ3VzdG9tSW5wdXRWYWx1ZSAmJiBpdGVtc1dpdGhDdXN0b21JbnB1dFZhbHVlLmxlbmd0aFxuICAgICAgICAgICAgICApID8gKFxuICAgICAgICAgICAgICAgIDxJdGVtc0NvbnRhaW5lckVtcHR5PlxuICAgICAgICAgICAgICAgICAgPEJvZHlUZXh0IHNpemU9ezN9IGxpbmVIZWlnaHQ9eyd4cyd9IHNjYWxlPXsneHMnfT5cbiAgICAgICAgICAgICAgICAgICAgTm8gaXRlbXMgZm91bmRcbiAgICAgICAgICAgICAgICAgIDwvQm9keVRleHQ+XG4gICAgICAgICAgICAgICAgPC9JdGVtc0NvbnRhaW5lckVtcHR5PlxuICAgICAgICAgICAgICApIDogKFxuICAgICAgICAgICAgICAgIGl0ZW1zV2l0aEN1c3RvbUlucHV0VmFsdWUubWFwKFxuICAgICAgICAgICAgICAgICAgKGl0ZW06IE11bHRpU2VsZWN0RHJvcGRvd25WYWx1ZSwgaW5kZXg6IG51bWJlcikgPT4gKFxuICAgICAgICAgICAgICAgICAgICA8SXRlbUNvbnRhaW5lclxuICAgICAgICAgICAgICAgICAgICAgIGFsaWduPVwiY2VudGVyXCJcbiAgICAgICAgICAgICAgICAgICAgICBqdXN0aWZ5PVwic3BhY2UtYmV0d2VlblwiXG4gICAgICAgICAgICAgICAgICAgICAgaXRlbXNTcGFjaW5nPXsxMH1cbiAgICAgICAgICAgICAgICAgICAgICBrZXk9e2Ake2l0ZW0udmFsdWV9JHtpbmRleH1gfVxuICAgICAgICAgICAgICAgICAgICAgIHsuLi5nZXRJdGVtUHJvcHMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2FyaWEtc2VsZWN0ZWQnOiBzZWxlY3RlZEl0ZW1zLmluY2x1ZGVzKGl0ZW0pLFxuICAgICAgICAgICAgICAgICAgICAgIH0pfVxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgPEJvZHlUZXh0IHNpemU9ezN9IGxpbmVIZWlnaHQ9eyd4cyd9IHNjYWxlPXsneHMnfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHtpdGVtLmxhYmVsfVxuICAgICAgICAgICAgICAgICAgICAgIDwvQm9keVRleHQ+XG4gICAgICAgICAgICAgICAgICAgIDwvSXRlbUNvbnRhaW5lcj5cbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApKX1cbiAgICAgICAgICA8L0l0ZW1zQ29udGFpbmVyPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvRmxleENvbHVtbj5cbiAgICA8L0Ryb3Bkb3duQ29udGFpbmVyPlxuICApO1xufVxuXG5leHBvcnQgZGVmYXVsdCBNdWx0aXNlbGVjdERyb3Bkb3duO1xuIl19