import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useState, useEffect } from 'react';
import styled from 'styled-components';
import { useMultipleSelection, useCombobox } from 'downshift';
import { useClickAndTouchAway } from '../../hooks/use-click-and-touch-away';
import FlexRow from '../flex-row/flex-row';
import FlexColumn from '../flex-column/flex-column';
import BodyText from '../body-text/body-text';
import SvgIcon from '../svg-icon/svg-icon';
import Input from '../input/input';
import { ArrowDownIcon, DeleteIcon, SearchIcon } from '../../icons-index';
const DropdownContainer = styled.div(({ theme, disabled }) => ({
    outline: 'none',
    ...(disabled && {
        opacity: '0.5',
        pointerEvents: 'none',
    }),
}));
const MultiSelectContainer = styled(FlexRow)(({ theme }) => ({
    borderRadius: theme.borderRadius.base,
    padding: '8px',
    background: theme.styleguideColors.fillSecondary,
    ':hover, :active': {
        svg: {
            color: theme.styleguideColors.fillPrimaryRed,
        },
    },
}));
const InputContainer = styled(FlexRow)(({ theme }) => ({
    width: '100%',
}));
const StyledInput = styled(Input)(() => ({
    width: '100%',
    border: 'none',
    height: '24px',
    '> div': {
        padding: '0 8px',
    },
}));
const DropdownIconWrapper = styled(FlexRow)(({ theme }) => ({
    paddingRight: '8px',
    marginLeft: '8px',
}));
const ArrowSvgIcon = styled(SvgIcon)(({ theme }) => ({
    path: {
        fill: theme.styleguideColors.contentPrimary,
    },
}));
const ClearSvgIcon = styled(SvgIcon)(({ theme }) => ({
    path: {
        stroke: theme.styleguideColors.contentPrimary,
    },
}));
const ChipItemContainer = styled.span(({ theme }) => ({
    borderRadius: theme.borderRadius.base,
    cursor: 'pointer',
    padding: '2px 8px',
    background: theme.styleguideColors.fillTertiary,
    color: theme.styleguideColors.contentPrimary,
    wordBreak: 'break-word',
}));
const ItemsContainer = styled.div(({ theme, isOpen }) => ({
    display: isOpen ? 'inherit' : 'none',
    marginTop: 4,
    borderRadius: theme.borderRadius.base,
    background: theme.styleguideColors.fillSecondary,
    maxHeight: '250px',
    overflowY: 'scroll',
}));
const ItemsContainerEmpty = styled(FlexRow)(({ theme }) => ({
    padding: '32px 16px',
    pointerEvents: 'none',
    justifyContent: 'center',
}));
const ItemContainer = styled(FlexRow)(({ theme }) => ({
    cursor: 'pointer',
    minHeight: 36,
    padding: '8px 16px',
    wordBreak: 'break-word',
    ':hover, :active': {
        background: theme.styleguideColors.fillSecondaryBlueHover,
        fontWeight: 600,
    },
}));
const MultiSelectDeleteIcon = styled(SvgIcon)(({ theme }) => ({
    path: {
        stroke: theme.styleguideColors.contentBlue,
    },
    ':hover, :active': {
        path: {
            stroke: theme.styleguideColors.contentRed,
        },
    },
}));
const getChangeEvent = (value) => {
    return {
        target: {
            name: undefined,
            value,
        },
    };
};
/** @deprecated use the new MultiselectDropdown component instead. */
export function MultiSelectInput(props) {
    const { items, value, label, placeholder, disabled = false, onSelectItem, onAddItem, onRemoveItem, onChangeInput, } = props;
    const [inputValue, setInputValue] = useState('');
    const { getSelectedItemProps, getDropdownProps, addSelectedItem, removeSelectedItem, selectedItems, setSelectedItems, reset, } = useMultipleSelection({
        initialSelectedItems: value,
        onSelectedItemsChange: (changes) => {
            onSelectItem && onSelectItem(getChangeEvent(changes.selectedItems));
        },
    });
    const inputValueItem = inputValue?.length >= 3
        ? [
            {
                id: inputValue,
                label: inputValue,
                value: inputValue,
                chipLabel: inputValue,
            },
        ]
        : [];
    const itemsWithCustomInputValue = [...inputValueItem, ...items];
    const { isOpen, getToggleButtonProps, getLabelProps, getMenuProps, getInputProps, getItemProps, openMenu, } = useCombobox({
        inputValue,
        items: itemsWithCustomInputValue,
        onStateChange: ({ inputValue, type, selectedItem: newSelectedItem }) => {
            switch (type) {
                case useCombobox.stateChangeTypes.InputChange:
                    setInputValue(inputValue || '');
                    onChangeInput && onChangeInput(inputValue || '');
                    break;
                case useCombobox.stateChangeTypes.InputKeyDownEnter:
                case useCombobox.stateChangeTypes.ItemClick:
                case useCombobox.stateChangeTypes.InputBlur:
                    const isAlreadySelected = selectedItems.some((i) => i.value === newSelectedItem?.value);
                    if (newSelectedItem) {
                        if (isAlreadySelected) {
                            setSelectedItems(selectedItems.filter((i) => i.value !== newSelectedItem.value));
                            onRemoveItem && onRemoveItem(getChangeEvent(newSelectedItem));
                        }
                        else {
                            addSelectedItem(newSelectedItem);
                            onAddItem && onAddItem(getChangeEvent(newSelectedItem));
                        }
                    }
                    break;
                case useCombobox.stateChangeTypes.FunctionCloseMenu:
                    handleClearInput();
                    break;
                default:
                    break;
            }
        },
        stateReducer: (state, actionAndChanges) => {
            const { changes, type } = actionAndChanges;
            switch (type) {
                case useCombobox.stateChangeTypes.InputKeyDownEnter:
                case useCombobox.stateChangeTypes.ItemClick:
                    return {
                        ...changes,
                        isOpen: state.isOpen, // keep the menu open after selection.
                    };
                default:
                    return changes;
            }
        },
    });
    const { ref: outerClickRef } = useClickAndTouchAway({
        callback: () => {
            if (isOpen) {
                handleClearInput();
            }
        },
    });
    //Align resetting selected values if they were reset in parent
    useEffect(() => {
        if (!value || value.length < 1) {
            reset();
        }
    }, [value]);
    const handleClearInput = () => {
        setInputValue('');
        onChangeInput && onChangeInput('');
    };
    const handleClearAll = () => {
        handleClearInput();
        onSelectItem && onSelectItem(getChangeEvent(null));
        reset();
    };
    const showInput = isOpen || selectedItems.length === 0;
    return (_jsx(DropdownContainer, { disabled: disabled, ref: outerClickRef, children: _jsxs(FlexColumn, { itemsSpacing: 4, children: [label && (_jsx(BodyText, { lineHeight: 'xs', ...getLabelProps(), size: 1, children: label })), _jsxs("div", { children: [_jsxs(MultiSelectContainer, { isOpen: isOpen, align: "center", justify: "space-between", ...getToggleButtonProps(getDropdownProps({ preventKeyAction: isOpen })), children: [_jsxs(InputContainer, { gap: 8, wrap: 'wrap', children: [selectedItems.map((selectedItem, index) => (_jsx(ChipItemContainer, { ...getSelectedItemProps({ selectedItem, index }), children: _jsx(BodyText, { lineHeight: 'xs', size: 3, variation: selectedItem ? 'inherit' : 'darkGray', children: _jsxs(FlexRow, { align: 'center', gap: 4, children: [selectedItem?.chipLabel || selectedItem?.label, _jsx(MultiSelectDeleteIcon, { onClick: (event) => {
                                                                event.preventDefault();
                                                                event.stopPropagation();
                                                                removeSelectedItem(selectedItem);
                                                            }, size: 14, src: DeleteIcon })] }) }) }, `selected-item-${index}`))), showInput ? (_jsx(StyledInput, { ...getInputProps({
                                                placeholder,
                                                value: inputValue || '',
                                                disabled,
                                                onFocus() {
                                                    openMenu();
                                                },
                                            }, { suppressRefError: true }), prefixIcon: _jsx(SvgIcon, { src: SearchIcon }) })) : null] }), _jsxs(DropdownIconWrapper, { children: [!!selectedItems.length && (_jsx(ClearSvgIcon, { src: DeleteIcon, onClick: handleClearAll, marginRight: true })), _jsx(ArrowSvgIcon, { src: ArrowDownIcon, rotate: isOpen })] })] }), _jsx(ItemsContainer, { ...getMenuProps(), isOpen: isOpen, children: isOpen &&
                                (!(itemsWithCustomInputValue && itemsWithCustomInputValue.length) ? (_jsx(ItemsContainerEmpty, { children: _jsx(BodyText, { size: 3, lineHeight: 'xs', scale: 'xs', children: "No items found" }) })) : (itemsWithCustomInputValue.map((item, index) => (_jsx(ItemContainer, { align: "center", justify: "space-between", itemsSpacing: 10, ...getItemProps({
                                        item,
                                        index,
                                        'aria-selected': selectedItems.includes(item),
                                    }), children: _jsx(BodyText, { size: 3, lineHeight: 'xs', scale: 'xs', children: item.label }) }, `${item.value}${index}`))))) })] })] }) }));
}
export default MultiSelectInput;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlzZWxlY3QtaW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NvbXBvbmVudHMvbXVsdGlzZWxlY3QtaW5wdXQvbXVsdGlzZWxlY3QtaW5wdXQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFjLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUNuRCxPQUFPLE1BQU0sTUFBTSxtQkFBbUIsQ0FBQztBQUN2QyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzVFLE9BQU8sT0FBTyxNQUFNLHNCQUFzQixDQUFDO0FBQzNDLE9BQU8sVUFBVSxNQUFNLDRCQUE0QixDQUFDO0FBQ3BELE9BQU8sUUFBUSxNQUFNLHdCQUF3QixDQUFDO0FBRTlDLE9BQU8sT0FBTyxNQUFNLHNCQUFzQixDQUFDO0FBQzNDLE9BQU8sS0FBSyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTFFLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FDbEMsQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN4QixPQUFPLEVBQUUsTUFBTTtJQUVmLEdBQUcsQ0FBQyxRQUFRLElBQUk7UUFDZCxPQUFPLEVBQUUsS0FBSztRQUNkLGFBQWEsRUFBRSxNQUFNO0tBQ3RCLENBQUM7Q0FDSCxDQUFDLENBQ0gsQ0FBQztBQUVGLE1BQU0sb0JBQW9CLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUMxQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDZCxZQUFZLEVBQUUsS0FBSyxDQUFD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LEVBQ3ZCLFlBQVksRUFBRSxFQUFFLEtBRVosWUFBWSxDQUFDO3dDQUNmLElBQUk7d0NBQ0osS0FBSzt3Q0FDTCxlQUFlLEVBQUUsYUFBYSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7cUNBQzlDLENBQUMsWUFFRixLQUFDLFFBQVEsSUFBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksWUFDN0MsSUFBSSxDQUFDLEtBQUssR0FDRixJQVROLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLEVBQUUsQ0FVZCxDQUNqQixDQUNGLENBQ0YsQ0FBQyxHQUNXLElBQ2IsSUFDSyxHQUNLLENBQ3JCLENBQUM7QUFDSixDQUFDO0FBRUQsZUFBZSxnQkFBZ0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgeyB1c2VNdWx0aXBsZVNlbGVjdGlvbiwgdXNlQ29tYm9ib3ggfSBmcm9tICdkb3duc2hpZnQnO1xuaW1wb3J0IHsgdXNlQ2xpY2tBbmRUb3VjaEF3YXkgfSBmcm9tICcuLi8uLi9ob29rcy91c2UtY2xpY2stYW5kLXRvdWNoLWF3YXknO1xuaW1wb3J0IEZsZXhSb3cgZnJvbSAnLi4vZmxleC1yb3cvZmxleC1yb3cnO1xuaW1wb3J0IEZsZXhDb2x1bW4gZnJvbSAnLi4vZmxleC1jb2x1bW4vZmxleC1jb2x1bW4nO1xuaW1wb3J0IEJvZHlUZXh0IGZyb20gJy4uL2JvZHktdGV4dC9ib2R5LXRleHQnO1xuaW1wb3J0IHsgQmFzZVByb3BzIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IFN2Z0ljb24gZnJvbSAnLi4vc3ZnLWljb24vc3ZnLWljb24nO1xuaW1wb3J0IElucHV0IGZyb20gJy4uL2lucHV0L2lucHV0JztcbmltcG9ydCB7IEFycm93RG93bkljb24sIERlbGV0ZUljb24sIFNlYXJjaEljb24gfSBmcm9tICcuLi8uLi9pY29ucy1pbmRleCc7XG5cbmNvbnN0IERyb3Bkb3duQ29udGFpbmVyID0gc3R5bGVkLmRpdjx7IGRpc2FibGVkPzogYm9vbGVhbiB9PihcbiAgKHsgdGhlbWUsIGRpc2FibGVkIH0pID0+ICh7XG4gICAgb3V0bGluZTogJ25vbmUnLFxuXG4gICAgLi4uKGRpc2FibGVkICYmIHtcbiAgICAgIG9wYWNpdHk6ICcwLjUnLFxuICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLFxuICAgIH0pLFxuICB9KSxcbik7XG5cbmNvbnN0IE11bHRpU2VsZWN0Q29udGFpbmVyID0gc3R5bGVkKEZsZXhSb3cpPHsgaXNPcGVuOiBib29sZWFuIH0+KFxuICAoeyB0aGVtZSB9KSA9PiAoe1xuICAgIGJvcmRlclJhZGl1czogdGhlbWUuYm9yZGVyUmFkaXVzLmJhc2UsXG4gICAgcGFkZGluZzogJzhweCcsXG4gICAgYmFja2dyb3VuZDogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5maWxsU2Vjb25kYXJ5LFxuICAgICc6aG92ZXIsIDphY3RpdmUnOiB7XG4gICAgICBzdmc6IHtcbiAgICAgICAgY29sb3I6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuZmlsbFByaW1hcnlSZWQsXG4gICAgICB9LFxuICAgIH0sXG4gIH0pLFxuKTtcblxuY29uc3QgSW5wdXRDb250YWluZXIgPSBzdHlsZWQoRmxleFJvdykoKHsgdGhlbWUgfSkgPT4gKHtcbiAgd2lkdGg6ICcxMDAlJyxcbn0pKTtcblxuY29uc3QgU3R5bGVkSW5wdXQgPSBzdHlsZWQoSW5wdXQpKCgpID0+ICh7XG4gIHdpZHRoOiAnMTAwJScsXG4gIGJvcmRlcjogJ25vbmUnLFxuICBoZWlnaHQ6ICcyNHB4JyxcbiAgJz4gZGl2Jzoge1xuICAgIHBhZGRpbmc6ICcwIDhweCcsXG4gIH0sXG59KSk7XG5cbmNvbnN0IERyb3Bkb3duSWNvbldyYXBwZXIgPSBzdHlsZWQoRmxleFJvdykoKHsgdGhlbWUgfSkgPT4gKHtcbiAgcGFkZGluZ1JpZ2h0OiAnOHB4JyxcbiAgbWFyZ2luTGVmdDogJzhweCcsXG59KSk7XG5cbmNvbnN0IEFycm93U3ZnSWNvbiA9IHN0eWxlZChTdmdJY29uKSgoeyB0aGVtZSB9KSA9PiAoe1xuICBwYXRoOiB7XG4gICAgZmlsbDogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5jb250ZW50UHJpbWFyeSxcbiAgfSxcbn0pKTtcblxuY29uc3QgQ2xlYXJTdmdJY29uID0gc3R5bGVkKFN2Z0ljb24pKCh7IHRoZW1lIH0pID0+ICh7XG4gIHBhdGg6IHtcbiAgICBzdHJva2U6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuY29udGVudFByaW1hcnksXG4gIH0sXG59KSk7XG5cbmNvbnN0IENoaXBJdGVtQ29udGFpbmVyID0gc3R5bGVkLnNwYW4oKHsgdGhlbWUgfSkgPT4gKHtcbiAgYm9yZGVyUmFkaXVzOiB0aGVtZS5ib3JkZXJSYWRpdXMuYmFzZSxcbiAgY3Vyc29yOiAncG9pbnRlcicsXG4gIHBhZGRpbmc6ICcycHggOHB4JyxcbiAgYmFja2dyb3VuZDogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5maWxsVGVydGlhcnksXG4gIGNvbG9yOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmNvbnRlbnRQcmltYXJ5LFxuICB3b3JkQnJlYWs6ICdicmVhay13b3JkJyxcbn0pKTtcblxuY29uc3QgSXRlbXNDb250YWluZXIgPSBzdHlsZWQuZGl2PHsgaXNPcGVuOiBib29sZWFuIH0+KCh7IHRoZW1lLCBpc09wZW4gfSkgPT4gKHtcbiAgZGlzcGxheTogaXNPcGVuID8gJ2luaGVyaXQnIDogJ25vbmUnLFxuICBtYXJnaW5Ub3A6IDQsXG4gIGJvcmRlclJhZGl1czogdGhlbWUuYm9yZGVyUmFkaXVzLmJhc2UsXG4gIGJhY2tncm91bmQ6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuZmlsbFNlY29uZGFyeSxcbiAgbWF4SGVpZ2h0OiAnMjUwcHgnLFxuICBvdmVyZmxvd1k6ICdzY3JvbGwnLFxufSkpO1xuXG5jb25zdCBJdGVtc0NvbnRhaW5lckVtcHR5ID0gc3R5bGVkKEZsZXhSb3cpKCh7IHRoZW1lIH0pID0+ICh7XG4gIHBhZGRpbmc6ICczMnB4IDE2cHgnLFxuICBwb2ludGVyRXZlbnRzOiAnbm9uZScsXG4gIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJyxcbn0pKTtcblxuY29uc3QgSXRlbUNvbnRhaW5lciA9IHN0eWxlZChGbGV4Um93KSgoeyB0aGVtZSB9KSA9PiAoe1xuICBjdXJzb3I6ICdwb2ludGVyJyxcbiAgbWluSGVpZ2h0OiAzNixcbiAgcGFkZGluZzogJzhweCAxNnB4JyxcbiAgd29yZEJyZWFrOiAnYnJlYWstd29yZCcsXG4gICc6aG92ZXIsIDphY3RpdmUnOiB7XG4gICAgYmFja2dyb3VuZDogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5maWxsU2Vjb25kYXJ5Qmx1ZUhvdmVyLFxuICAgIGZvbnRXZWlnaHQ6IDYwMCxcbiAgfSxcbn0pKTtcblxuY29uc3QgTXVsdGlTZWxlY3REZWxldGVJY29uID0gc3R5bGVkKFN2Z0ljb24pKCh7IHRoZW1lIH0pID0+ICh7XG4gIHBhdGg6IHtcbiAgICBzdHJva2U6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuY29udGVudEJsdWUsXG4gIH0sXG4gICc6aG92ZXIsIDphY3RpdmUnOiB7XG4gICAgcGF0aDoge1xuICAgICAgc3Ryb2tlOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmNvbnRlbnRSZWQsXG4gICAgfSxcbiAgfSxcbn0pKTtcblxuZXhwb3J0IHR5cGUgTXVsdGlTZWxlY3REcm9wZG93blZhbHVlID0ge1xuICBsYWJlbDogc3RyaW5nO1xuICBjaGlwTGFiZWw/OiBzdHJpbmc7XG4gIHZhbHVlOiBhbnk7XG59O1xuXG5leHBvcnQgdHlwZSBNdWx0aVNlbGVjdERyb3Bkb3duRXZlbnRWYWx1ZSA9IHtcbiAgdGFyZ2V0OiB7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB2YWx1ZTogTXVsdGlTZWxlY3REcm9wZG93blZhbHVlIHwgbnVsbDtcbiAgfTtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTXVsdGlTZWxlY3RJbnB1dFByb3BzIGV4dGVuZHMgQmFzZVByb3BzIHtcbiAgdmFsdWU/OiBNdWx0aVNlbGVjdERyb3Bkb3duVmFsdWVbXTtcbiAgaXRlbXM6IE11bHRpU2VsZWN0RHJvcGRvd25WYWx1ZVtdO1xuICBsYWJlbD86IHN0cmluZyB8IEpTWC5FbGVtZW50O1xuICBwbGFjZWhvbGRlcj86IHN0cmluZztcbiAgZGlzYWJsZWQ/OiBib29sZWFuO1xuICBvbkFkZEl0ZW0/OiAoZXY6IE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlKSA9PiB2b2lkO1xuICBvblNlbGVjdEl0ZW0/OiAoZXY6IE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlKSA9PiB2b2lkO1xuICBvblJlbW92ZUl0ZW0/OiAoZXY6IE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlKSA9PiB2b2lkO1xuICBvbkNoYW5nZUlucHV0PzogKHZhbHVlOiBzdHJpbmcpID0+IHZvaWQ7XG59XG5cbmNvbnN0IGdldENoYW5nZUV2ZW50ID0gKHZhbHVlOiBhbnkpOiBNdWx0aVNlbGVjdERyb3Bkb3duRXZlbnRWYWx1ZSA9PiB7XG4gIHJldHVybiB7XG4gICAgdGFyZ2V0OiB7XG4gICAgICBuYW1lOiB1bmRlZmluZWQsXG4gICAgICB2YWx1ZSxcbiAgICB9LFxuICB9O1xufTtcblxuLyoqIEBkZXByZWNhdGVkIHVzZSB0aGUgbmV3IE11bHRpc2VsZWN0RHJvcGRvd24gY29tcG9uZW50IGluc3RlYWQuICovXG5leHBvcnQgZnVuY3Rpb24gTXVsdGlTZWxlY3RJbnB1dChwcm9wczogTXVsdGlTZWxlY3RJbnB1dFByb3BzKSB7XG4gIGNvbnN0IHtcbiAgICBpdGVtcyxcbiAgICB2YWx1ZSxcbiAgICBsYWJlbCxcbiAgICBwbGFjZWhvbGRlcixcbiAgICBkaXNhYmxlZCA9IGZhbHNlLFxuICAgIG9uU2VsZWN0SXRlbSxcbiAgICBvbkFkZEl0ZW0sXG4gICAgb25SZW1vdmVJdGVtLFxuICAgIG9uQ2hhbmdlSW5wdXQsXG4gIH0gPSBwcm9wcztcbiAgY29uc3QgW2lucHV0VmFsdWUsIHNldElucHV0VmFsdWVdID0gdXNlU3RhdGU8c3RyaW5nPignJyk7XG5cbiAgY29uc3Qge1xuICAgIGdldFNlbGVjdGVkSXRlbVByb3BzLFxuICAgIGdldERyb3Bkb3duUHJvcHMsXG4gICAgYWRkU2VsZWN0ZWRJdGVtLFxuICAgIHJlbW92ZVNlbGVjdGVkSXRlbSxcbiAgICBzZWxlY3RlZEl0ZW1zLFxuICAgIHNldFNlbGVjdGVkSXRlbXMsXG4gICAgcmVzZXQsXG4gIH0gPSB1c2VNdWx0aXBsZVNlbGVjdGlvbjxNdWx0aVNlbGVjdERyb3Bkb3duVmFsdWU+KHtcbiAgICBpbml0aWFsU2VsZWN0ZWRJdGVtczogdmFsdWUsXG4gICAgb25TZWxlY3RlZEl0ZW1zQ2hhbmdlOiAoY2hhbmdlcykgPT4ge1xuICAgICAgb25TZWxlY3RJdGVtICYmIG9uU2VsZWN0SXRlbShnZXRDaGFuZ2VFdmVudChjaGFuZ2VzLnNlbGVjdGVkSXRlbXMpKTtcbiAgICB9LFxuICB9KTtcblxuICBjb25zdCBpbnB1dFZhbHVlSXRlbSA9XG4gICAgaW5wdXRWYWx1ZT8ubGVuZ3RoID49IDNcbiAgICAgID8gW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiBpbnB1dFZhbHVlLFxuICAgICAgICAgICAgbGFiZWw6IGlucHV0VmFsdWUsXG4gICAgICAgICAgICB2YWx1ZTogaW5wdXRWYWx1ZSxcbiAgICAgICAgICAgIGNoaXBMYWJlbDogaW5wdXRWYWx1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICBdXG4gICAgICA6IFtdO1xuXG4gIGNvbnN0IGl0ZW1zV2l0aEN1c3RvbUlucHV0VmFsdWUgPSBbLi4uaW5wdXRWYWx1ZUl0ZW0sIC4uLml0ZW1zXTtcblxuICBjb25zdCB7XG4gICAgaXNPcGVuLFxuICAgIGdldFRvZ2dsZUJ1dHRvblByb3BzLFxuICAgIGdldExhYmVsUHJvcHMsXG4gICAgZ2V0TWVudVByb3BzLFxuICAgIGdldElucHV0UHJvcHMsXG4gICAgZ2V0SXRlbVByb3BzLFxuICAgIG9wZW5NZW51LFxuICB9ID0gdXNlQ29tYm9ib3g8TXVsdGlTZWxlY3REcm9wZG93blZhbHVlPih7XG4gICAgaW5wdXRWYWx1ZSxcbiAgICBpdGVtczogaXRlbXNXaXRoQ3VzdG9tSW5wdXRWYWx1ZSxcbiAgICBvblN0YXRlQ2hhbmdlOiAoeyBpbnB1dFZhbHVlLCB0eXBlLCBzZWxlY3RlZEl0ZW06IG5ld1NlbGVjdGVkSXRlbSB9KSA9PiB7XG4gICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLklucHV0Q2hhbmdlOlxuICAgICAgICAgIHNldElucHV0VmFsdWUoaW5wdXRWYWx1ZSB8fCAnJyk7XG4gICAgICAgICAgb25DaGFuZ2VJbnB1dCAmJiBvbkNoYW5nZUlucHV0KGlucHV0VmFsdWUgfHwgJycpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgdXNlQ29tYm9ib3guc3RhdGVDaGFuZ2VUeXBlcy5JbnB1dEtleURvd25FbnRlcjpcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLkl0ZW1DbGljazpcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLklucHV0Qmx1cjpcbiAgICAgICAgICBjb25zdCBpc0FscmVhZHlTZWxlY3RlZCA9IHNlbGVjdGVkSXRlbXMuc29tZShcbiAgICAgICAgICAgIChpKSA9PiBpLnZhbHVlID09PSBuZXdTZWxlY3RlZEl0ZW0/LnZhbHVlLFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAobmV3U2VsZWN0ZWRJdGVtKSB7XG4gICAgICAgICAgICBpZiAoaXNBbHJlYWR5U2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRJdGVtcyhcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1zLmZpbHRlcigoaSkgPT4gaS52YWx1ZSAhPT0gbmV3U2VsZWN0ZWRJdGVtLnZhbHVlKSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgb25SZW1vdmVJdGVtICYmIG9uUmVtb3ZlSXRlbShnZXRDaGFuZ2VFdmVudChuZXdTZWxlY3RlZEl0ZW0pKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGFkZFNlbGVjdGVkSXRlbShuZXdTZWxlY3RlZEl0ZW0pO1xuICAgICAgICAgICAgICBvbkFkZEl0ZW0gJiYgb25BZGRJdGVtKGdldENoYW5nZUV2ZW50KG5ld1NlbGVjdGVkSXRlbSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLkZ1bmN0aW9uQ2xvc2VNZW51OlxuICAgICAgICAgIGhhbmRsZUNsZWFySW5wdXQoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9LFxuICAgIHN0YXRlUmVkdWNlcjogKHN0YXRlLCBhY3Rpb25BbmRDaGFuZ2VzKSA9PiB7XG4gICAgICBjb25zdCB7IGNoYW5nZXMsIHR5cGUgfSA9IGFjdGlvbkFuZENoYW5nZXM7XG4gICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgY2FzZSB1c2VDb21ib2JveC5zdGF0ZUNoYW5nZVR5cGVzLklucHV0S2V5RG93bkVudGVyOlxuICAgICAgICBjYXNlIHVzZUNvbWJvYm94LnN0YXRlQ2hhbmdlVHlwZXMuSXRlbUNsaWNrOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5jaGFuZ2VzLFxuICAgICAgICAgICAgaXNPcGVuOiBzdGF0ZS5pc09wZW4sIC8vIGtlZXAgdGhlIG1lbnUgb3BlbiBhZnRlciBzZWxlY3Rpb24uXG4gICAgICAgICAgfTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gY2hhbmdlcztcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcblxuICBjb25zdCB7IHJlZjogb3V0ZXJDbGlja1JlZiB9ID0gdXNlQ2xpY2tBbmRUb3VjaEF3YXkoe1xuICAgIGNhbGxiYWNrOiAoKSA9PiB7XG4gICAgICBpZiAoaXNPcGVuKSB7XG4gICAgICAgIGhhbmRsZUNsZWFySW5wdXQoKTtcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcblxuICAvL0FsaWduIHJlc2V0dGluZyBzZWxlY3RlZCB2YWx1ZXMgaWYgdGhleSB3ZXJlIHJlc2V0IGluIHBhcmVudFxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmICghdmFsdWUgfHwgdmFsdWUubGVuZ3RoIDwgMSkge1xuICAgICAgcmVzZXQoKTtcbiAgICB9XG4gIH0sIFt2YWx1ZV0pO1xuXG4gIGNvbnN0IGhhbmRsZUNsZWFySW5wdXQgPSAoKSA9PiB7XG4gICAgc2V0SW5wdXRWYWx1ZSgnJyk7XG4gICAgb25DaGFuZ2VJbnB1dCAmJiBvbkNoYW5nZUlucHV0KCcnKTtcbiAgfTtcblxuICBjb25zdCBoYW5kbGVDbGVhckFsbCA9ICgpID0+IHtcbiAgICBoYW5kbGVDbGVhcklucHV0KCk7XG4gICAgb25TZWxlY3RJdGVtICYmIG9uU2VsZWN0SXRlbShnZXRDaGFuZ2VFdmVudChudWxsKSk7XG4gICAgcmVzZXQoKTtcbiAgfTtcblxuICBjb25zdCBzaG93SW5wdXQgPSBpc09wZW4gfHwgc2VsZWN0ZWRJdGVtcy5sZW5ndGggPT09IDA7XG5cbiAgcmV0dXJuIChcbiAgICA8RHJvcGRvd25Db250YWluZXIgZGlzYWJsZWQ9e2Rpc2FibGVkfSByZWY9e291dGVyQ2xpY2tSZWZ9PlxuICAgICAgPEZsZXhDb2x1bW4gaXRlbXNTcGFjaW5nPXs0fT5cbiAgICAgICAge2xhYmVsICYmIChcbiAgICAgICAgICA8Qm9keVRleHQgbGluZUhlaWdodD17J3hzJ30gey4uLmdldExhYmVsUHJvcHMoKX0gc2l6ZT17MX0+XG4gICAgICAgICAgICB7bGFiZWx9XG4gICAgICAgICAgPC9Cb2R5VGV4dD5cbiAgICAgICAgKX1cbiAgICAgICAgPGRpdj5cbiAgICAgICAgICA8TXVsdGlTZWxlY3RDb250YWluZXJcbiAgICAgICAgICAgIGlzT3Blbj17aXNPcGVufVxuICAgICAgICAgICAgYWxpZ249XCJjZW50ZXJcIlxuICAgICAgICAgICAganVzdGlmeT1cInNwYWNlLWJldHdlZW5cIlxuICAgICAgICAgICAgey4uLmdldFRvZ2dsZUJ1dHRvblByb3BzKFxuICAgICAgICAgICAgICBnZXREcm9wZG93blByb3BzKHsgcHJldmVudEtleUFjdGlvbjogaXNPcGVuIH0pLFxuICAgICAgICAgICAgKX1cbiAgICAgICAgICA+XG4gICAgICAgICAgICA8SW5wdXRDb250YWluZXIgZ2FwPXs4fSB3cmFwPXsnd3JhcCd9PlxuICAgICAgICAgICAgICB7c2VsZWN0ZWRJdGVtcy5tYXAoKHNlbGVjdGVkSXRlbSwgaW5kZXgpID0+IChcbiAgICAgICAgICAgICAgICA8Q2hpcEl0ZW1Db250YWluZXJcbiAgICAgICAgICAgICAgICAgIGtleT17YHNlbGVjdGVkLWl0ZW0tJHtpbmRleH1gfVxuICAgICAgICAgICAgICAgICAgey4uLmdldFNlbGVjdGVkSXRlbVByb3BzKHsgc2VsZWN0ZWRJdGVtLCBpbmRleCB9KX1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICA8Qm9keVRleHRcbiAgICAgICAgICAgICAgICAgICAgbGluZUhlaWdodD17J3hzJ31cbiAgICAgICAgICAgICAgICAgICAgc2l6ZT17M31cbiAgICAgICAgICAgICAgICAgICAgdmFyaWF0aW9uPXtzZWxlY3RlZEl0ZW0gPyAnaW5oZXJpdCcgOiAnZGFya0dyYXknfVxuICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8RmxleFJvdyBhbGlnbj17J2NlbnRlcid9IGdhcD17NH0+XG4gICAgICAgICAgICAgICAgICAgICAge3NlbGVjdGVkSXRlbT8uY2hpcExhYmVsIHx8IHNlbGVjdGVkSXRlbT8ubGFiZWx9XG4gICAgICAgICAgICAgICAgICAgICAgPE11bHRpU2VsZWN0RGVsZXRlSWNvblxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVTZWxlY3RlZEl0ZW0oc2VsZWN0ZWRJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICAgICAgICBzaXplPXsxNH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHNyYz17RGVsZXRlSWNvbn1cbiAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICA8L0ZsZXhSb3c+XG4gICAgICAgICAgICAgICAgICA8L0JvZHlUZXh0PlxuICAgICAgICAgICAgICAgIDwvQ2hpcEl0ZW1Db250YWluZXI+XG4gICAgICAgICAgICAgICkpfVxuICAgICAgICAgICAgICB7c2hvd0lucHV0ID8gKFxuICAgICAgICAgICAgICAgIDxTdHlsZWRJbnB1dFxuICAgICAgICAgICAgICAgICAgey4uLmdldElucHV0UHJvcHMoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaW5wdXRWYWx1ZSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZCxcbiAgICAgICAgICAgICAgICAgICAgICBvbkZvY3VzKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3Blbk1lbnUoKTtcbiAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7IHN1cHByZXNzUmVmRXJyb3I6IHRydWUgfSxcbiAgICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgICAgICBwcmVmaXhJY29uPXs8U3ZnSWNvbiBzcmM9e1NlYXJjaEljb259IC8+fVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICkgOiBudWxsfVxuICAgICAgICAgICAgPC9JbnB1dENvbnRhaW5lcj5cbiAgICAgICAgICAgIDxEcm9wZG93bkljb25XcmFwcGVyPlxuICAgICAgICAgICAgICB7ISFzZWxlY3RlZEl0ZW1zLmxlbmd0aCAmJiAoXG4gICAgICAgICAgICAgICAgPENsZWFyU3ZnSWNvblxuICAgICAgICAgICAgICAgICAgc3JjPXtEZWxldGVJY29ufVxuICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlQ2xlYXJBbGx9XG4gICAgICAgICAgICAgICAgICBtYXJnaW5SaWdodFxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgIDxBcnJvd1N2Z0ljb24gc3JjPXtBcnJvd0Rvd25JY29ufSByb3RhdGU9e2lzT3Blbn0gLz5cbiAgICAgICAgICAgIDwvRHJvcGRvd25JY29uV3JhcHBlcj5cbiAgICAgICAgICA8L011bHRpU2VsZWN0Q29udGFpbmVyPlxuICAgICAgICAgIDxJdGVtc0NvbnRhaW5lciB7Li4uZ2V0TWVudVByb3BzKCl9IGlzT3Blbj17aXNPcGVufT5cbiAgICAgICAgICAgIHtpc09wZW4gJiZcbiAgICAgICAgICAgICAgKCEoXG4gICAgICAgICAgICAgICAgaXRlbXNXaXRoQ3VzdG9tSW5wdXRWYWx1ZSAmJiBpdGVtc1dpdGhDdXN0b21JbnB1dFZhbHVlLmxlbmd0aFxuICAgICAgICAgICAgICApID8gKFxuICAgICAgICAgICAgICAgIDxJdGVtc0NvbnRhaW5lckVtcHR5PlxuICAgICAgICAgICAgICAgICAgPEJvZHlUZXh0IHNpemU9ezN9IGxpbmVIZWlnaHQ9eyd4cyd9IHNjYWxlPXsneHMnfT5cbiAgICAgICAgICAgICAgICAgICAgTm8gaXRlbXMgZm91bmRcbiAgICAgICAgICAgICAgICAgIDwvQm9keVRleHQ+XG4gICAgICAgICAgICAgICAgPC9JdGVtc0NvbnRhaW5lckVtcHR5PlxuICAgICAgICAgICAgICApIDogKFxuICAgICAgICAgICAgICAgIGl0ZW1zV2l0aEN1c3RvbUlucHV0VmFsdWUubWFwKFxuICAgICAgICAgICAgICAgICAgKGl0ZW06IE11bHRpU2VsZWN0RHJvcGRvd25WYWx1ZSwgaW5kZXg6IG51bWJlcikgPT4gKFxuICAgICAgICAgICAgICAgICAgICA8SXRlbUNvbnRhaW5lclxuICAgICAgICAgICAgICAgICAgICAgIGFsaWduPVwiY2VudGVyXCJcbiAgICAgICAgICAgICAgICAgICAgICBqdXN0aWZ5PVwic3BhY2UtYmV0d2VlblwiXG4gICAgICAgICAgICAgICAgICAgICAgaXRlbXNTcGFjaW5nPXsxMH1cbiAgICAgICAgICAgICAgICAgICAgICBrZXk9e2Ake2l0ZW0udmFsdWV9JHtpbmRleH1gfVxuICAgICAgICAgICAgICAgICAgICAgIHsuLi5nZXRJdGVtUHJvcHMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2FyaWEtc2VsZWN0ZWQnOiBzZWxlY3RlZEl0ZW1zLmluY2x1ZGVzKGl0ZW0pLFxuICAgICAgICAgICAgICAgICAgICAgIH0pfVxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgPEJvZHlUZXh0IHNpemU9ezN9IGxpbmVIZWlnaHQ9eyd4cyd9IHNjYWxlPXsneHMnfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHtpdGVtLmxhYmVsfVxuICAgICAgICAgICAgICAgICAgICAgIDwvQm9keVRleHQ+XG4gICAgICAgICAgICAgICAgICAgIDwvSXRlbUNvbnRhaW5lcj5cbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApKX1cbiAgICAgICAgICA8L0l0ZW1zQ29udGFpbmVyPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvRmxleENvbHVtbj5cbiAgICA8L0Ryb3Bkb3duQ29udGFpbmVyPlxuICApO1xufVxuXG5leHBvcnQgZGVmYXVsdCBNdWx0aVNlbGVjdElucHV0O1xuIl19