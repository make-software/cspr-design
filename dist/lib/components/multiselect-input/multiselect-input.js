import { __assign, __spreadArray } from "tslib";
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useState, useEffect } from 'react';
import styled from 'styled-components';
import { useMultipleSelection, useCombobox } from 'downshift';
import DownIcon from 'assets/icons/ic-arrow-down.svg';
import SearchIcon from 'assets/icons/ic-search.svg';
import DeleteIcon from 'assets/icons/ic-delete.svg';
import { useClickAndTouchAway } from '../../hooks/use-click-and-touch-away';
import FlexRow from '../flex-row/flex-row';
import FlexColumn from '../flex-column/flex-column';
import BodyText from '../body-text/body-text';
import SvgIcon from '../svg-icon/svg-icon';
import Input from '../input/input';
var DropdownContainer = styled.div(function (_a) {
    var theme = _a.theme, disabled = _a.disabled;
    return (__assign({ outline: 'none' }, (disabled && {
        opacity: '0.5',
        pointerEvents: 'none',
    })));
});
var MultiSelectContainer = styled(FlexRow)(function (_a) {
    var theme = _a.theme;
    return ({
        borderRadius: theme.borderRadius.base,
        padding: '8px',
        background: theme.styleguideColors.fillSecondary,
        ':hover, :active': {
            svg: {
                color: theme.styleguideColors.fillPrimaryRed,
            },
        },
    });
});
var InputContainer = styled(FlexRow)(function (_a) {
    var theme = _a.theme;
    return ({
        width: '100%',
    });
});
var StyledInput = styled(Input)(function () { return ({
    width: '100%',
    border: 'none',
    height: '24px',
    '> div': {
        padding: '0 8px',
    },
}); });
var DropdownIconWrapper = styled(FlexRow)(function (_a) {
    var theme = _a.theme;
    return ({
        paddingRight: '8px',
        marginLeft: '8px',
    });
});
var ArrowSvgIcon = styled(SvgIcon)(function (_a) {
    var theme = _a.theme;
    return ({
        path: {
            fill: theme.styleguideColors.contentPrimary,
        },
    });
});
var ClearSvgIcon = styled(SvgIcon)(function (_a) {
    var theme = _a.theme;
    return ({
        path: {
            stroke: theme.styleguideColors.contentPrimary,
        },
    });
});
var ChipItemContainer = styled.span(function (_a) {
    var theme = _a.theme;
    return ({
        borderRadius: theme.borderRadius.base,
        cursor: 'pointer',
        padding: '2px 8px',
        background: theme.styleguideColors.fillTertriary,
        color: theme.styleguideColors.contentPrimary,
        wordBreak: 'break-word',
    });
});
var ItemsContainer = styled.div(function (_a) {
    var theme = _a.theme, isOpen = _a.isOpen;
    return ({
        display: isOpen ? 'inherit' : 'none',
        marginTop: 4,
        borderRadius: theme.borderRadius.base,
        background: theme.styleguideColors.fillSecondary,
        maxHeight: '250px',
        overflowY: 'scroll',
    });
});
var ItemsContainerEmpty = styled(FlexRow)(function (_a) {
    var theme = _a.theme;
    return ({
        padding: '32px 16px',
        pointerEvents: 'none',
        justifyContent: 'center',
    });
});
var ItemContainer = styled(FlexRow)(function (_a) {
    var theme = _a.theme;
    return ({
        cursor: 'pointer',
        minHeight: 36,
        padding: '8px 16px',
        wordBreak: 'break-word',
        ':hover, :active': {
            background: theme.styleguideColors.fillSecondaryBlueHover,
            fontWeight: 600,
        },
    });
});
var MultiSelectDeleteIcon = styled(SvgIcon)(function (_a) {
    var theme = _a.theme;
    return ({
        path: {
            stroke: theme.styleguideColors.contentBlue,
        },
        ':hover, :active': {
            path: {
                stroke: theme.styleguideColors.contentRed,
            },
        },
    });
});
var getChangeEvent = function (value) {
    return {
        target: {
            name: undefined,
            value: value,
        },
    };
};
export function MultiSelectInput(props) {
    var items = props.items, value = props.value, label = props.label, placeholder = props.placeholder, _a = props.disabled, disabled = _a === void 0 ? false : _a, onSelectItem = props.onSelectItem, onAddItem = props.onAddItem, onRemoveItem = props.onRemoveItem, onChangeInput = props.onChangeInput;
    var _b = useState(''), inputValue = _b[0], setInputValue = _b[1];
    var _c = useMultipleSelection({
        initialSelectedItems: value,
        onSelectedItemsChange: function (changes) {
            onSelectItem && onSelectItem(getChangeEvent(changes.selectedItems));
        },
    }), getSelectedItemProps = _c.getSelectedItemProps, getDropdownProps = _c.getDropdownProps, addSelectedItem = _c.addSelectedItem, removeSelectedItem = _c.removeSelectedItem, selectedItems = _c.selectedItems, setSelectedItems = _c.setSelectedItems, reset = _c.reset;
    var inputValueItem = (inputValue === null || inputValue === void 0 ? void 0 : inputValue.length) >= 3
        ? [
            {
                id: inputValue,
                label: inputValue,
                value: inputValue,
                chipLabel: inputValue,
            },
        ]
        : [];
    var itemsWithCustomInputValue = __spreadArray(__spreadArray([], inputValueItem, true), items, true);
    var _d = useCombobox({
        inputValue: inputValue,
        items: itemsWithCustomInputValue,
        onStateChange: function (_a) {
            var inputValue = _a.inputValue, type = _a.type, newSelectedItem = _a.selectedItem;
            switch (type) {
                case useCombobox.stateChangeTypes.InputChange:
                    setInputValue(inputValue || '');
                    onChangeInput && onChangeInput(inputValue || '');
                    break;
                case useCombobox.stateChangeTypes.InputKeyDownEnter:
                case useCombobox.stateChangeTypes.ItemClick:
                case useCombobox.stateChangeTypes.InputBlur:
                    var isAlreadySelected = selectedItems.some(function (i) { return i.value === (newSelectedItem === null || newSelectedItem === void 0 ? void 0 : newSelectedItem.value); });
                    if (newSelectedItem) {
                        if (isAlreadySelected) {
                            setSelectedItems(selectedItems.filter(function (i) { return i.value !== newSelectedItem.value; }));
                            onRemoveItem && onRemoveItem(getChangeEvent(newSelectedItem));
                        }
                        else {
                            addSelectedItem(newSelectedItem);
                            onAddItem && onAddItem(getChangeEvent(newSelectedItem));
                        }
                    }
                    break;
                case useCombobox.stateChangeTypes.FunctionCloseMenu:
                    handleClearInput();
                    break;
                default:
                    break;
            }
        },
        stateReducer: function (state, actionAndChanges) {
            var changes = actionAndChanges.changes, type = actionAndChanges.type;
            switch (type) {
                case useCombobox.stateChangeTypes.InputKeyDownEnter:
                case useCombobox.stateChangeTypes.ItemClick:
                    return __assign(__assign({}, changes), { isOpen: state.isOpen });
                default:
                    return changes;
            }
        },
    }), isOpen = _d.isOpen, getToggleButtonProps = _d.getToggleButtonProps, getLabelProps = _d.getLabelProps, getMenuProps = _d.getMenuProps, getInputProps = _d.getInputProps, getItemProps = _d.getItemProps, openMenu = _d.openMenu;
    var outerClickRef = useClickAndTouchAway({
        callback: function () {
            if (isOpen) {
                handleClearInput();
            }
        },
    }).ref;
    //Align resetting selected values if they were reset in parent
    useEffect(function () {
        if (!value || value.length < 1) {
            reset();
        }
    }, [value]);
    var handleClearInput = function () {
        setInputValue('');
        onChangeInput && onChangeInput('');
    };
    var handleClearAll = function () {
        handleClearInput();
        onSelectItem && onSelectItem(getChangeEvent(null));
        reset();
    };
    var showInput = isOpen || selectedItems.length === 0;
    return (_jsx(DropdownContainer, __assign({ disabled: disabled, ref: outerClickRef }, { children: _jsxs(FlexColumn, __assign({ itemsSpacing: 4 }, { children: [label && (_jsx(BodyText, __assign({ lineHeight: 'xs' }, getLabelProps(), { size: 1 }, { children: label }))), _jsxs("div", { children: [_jsxs(MultiSelectContainer, __assign({ isOpen: isOpen, align: "center", justify: "space-between" }, getToggleButtonProps(getDropdownProps({ preventKeyAction: isOpen })), { children: [_jsxs(InputContainer, __assign({ gap: 8, wrap: 'wrap' }, { children: [selectedItems.map(function (selectedItem, index) { return (_jsx(ChipItemContainer, __assign({}, getSelectedItemProps({ selectedItem: selectedItem, index: index }), { children: _jsx(BodyText, __assign({ lineHeight: 'xs', size: 3, variation: selectedItem ? 'inherit' : 'darkGray' }, { children: _jsxs(FlexRow, __assign({ align: 'center', gap: 4 }, { children: [(selectedItem === null || selectedItem === void 0 ? void 0 : selectedItem.chipLabel) || (selectedItem === null || selectedItem === void 0 ? void 0 : selectedItem.label), _jsx(MultiSelectDeleteIcon, { onClick: function (event) {
                                                                event.preventDefault();
                                                                event.stopPropagation();
                                                                removeSelectedItem(selectedItem);
                                                            }, size: 14, src: DeleteIcon })] })) })) }), "selected-item-".concat(index))); }), showInput ? (_jsx(StyledInput, __assign({}, getInputProps({
                                            placeholder: placeholder,
                                            value: inputValue || '',
                                            disabled: disabled,
                                            onFocus: function () {
                                                openMenu();
                                            },
                                        }, { suppressRefError: true }), { prefixIcon: _jsx(SvgIcon, { src: SearchIcon }) }))) : null] })), _jsxs(DropdownIconWrapper, { children: [!!selectedItems.length && (_jsx(ClearSvgIcon, { src: DeleteIcon, onClick: handleClearAll, marginRight: true })), _jsx(ArrowSvgIcon, { src: DownIcon, rotate: isOpen })] })] })), _jsx(ItemsContainer, __assign({}, getMenuProps(), { isOpen: isOpen }, { children: isOpen &&
                                (!(itemsWithCustomInputValue && itemsWithCustomInputValue.length) ? (_jsx(ItemsContainerEmpty, { children: _jsx(BodyText, __assign({ size: 3, lineHeight: 'xs', scale: 'xs' }, { children: "No items found" })) })) : (itemsWithCustomInputValue.map(function (item, index) { return (_jsx(ItemContainer, __assign({ align: "center", justify: "space-between", itemsSpacing: 10 }, getItemProps({
                                    item: item,
                                    index: index,
                                    'aria-selected': selectedItems.includes(item),
                                }), { children: _jsx(BodyText, __assign({ size: 3, lineHeight: 'xs', scale: 'xs' }, { children: item.label })) }), "".concat(item.value).concat(index))); }))) }))] })] })) })));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlzZWxlY3QtaW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NvbXBvbmVudHMvbXVsdGlzZWxlY3QtaW5wdXQvbXVsdGlzZWxlY3QtaW5wdXQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBYyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDbkQsT0FBTyxNQUFNLE1BQU0sbUJBQW1CLENBQUM7QUFDdkMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM5RCxPQUFPLFFBQVEsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN0RCxPQUFPLFVBQVUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRCxPQUFPLFVBQVUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUM1RSxPQUFPLE9BQU8sTUFBTSxzQkFBc0IsQ0FBQztBQUMzQyxPQUFPLFVBQVUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRCxPQUFPLFFBQVEsTUFBTSx3QkFBd0IsQ0FBQztBQUU5QyxPQUFPLE9BQU8sTUFBTSxzQkFBc0IsQ0FBQztBQUMzQyxPQUFPLEtBQUssTUFBTSxnQkFBZ0IsQ0FBQztBQUVuQyxJQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQ2xDLFVBQUMsRUFBbUI7UUFBakIsS0FBSyxXQUFBLEVBQUUsUUFBUSxjQUFBO0lBQU8sT0FBQSxZQUN2QixPQUFPLEVBQUUsTUFBTSxJQUVaLENBQUMsUUFBUSxJQUFJO1FBQ2QsT0FBTyxFQUFFLEtBQUs7UUFDZCxhQUFhLEVBQUUsTUFBTTtLQUN0QixDQUFDLEVBQ0Y7QUFQdUIsQ0FPdkIsQ0FDSCxDQUFDO0FBRUYsSUFBTSxvQkFBb0IsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQzFDLFVBQUMsRUFBUztRQUFQLEtBQUssV0FB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QU0sRUFBRSxNQUFNLGdCQUMvQyxNQUFNO2dDQUNMLENBQUMsQ0FBQyxDQUNBLHlCQUF5QixJQUFJLHlCQUF5QixDQUFDLE1BQU0sQ0FDOUQsQ0FBQyxDQUFDLENBQUMsQ0FDRixLQUFDLG1CQUFtQixjQUNsQixLQUFDLFFBQVEsYUFBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksb0NBRXJDLEdBQ1MsQ0FDdkIsQ0FBQyxDQUFDLENBQUMsQ0FDRix5QkFBeUIsQ0FBQyxHQUFHLENBQzNCLFVBQUMsSUFBOEIsRUFBRSxLQUFhLElBQUssT0FBQSxDQUNqRCxLQUFDLGFBQWEsYUFDWixLQUFLLEVBQUMsUUFBUSxFQUNkLE9BQU8sRUFBQyxlQUFlLEVBQ3ZCLFlBQVksRUFBRSxFQUFFLElBRVosWUFBWSxDQUFDO29DQUNmLElBQUksTUFBQTtvQ0FDSixLQUFLLE9BQUE7b0NBQ0wsZUFBZSxFQUFFLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO2lDQUM5QyxDQUFDLGNBRUYsS0FBQyxRQUFRLGFBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLGdCQUM3QyxJQUFJLENBQUMsS0FBSyxJQUNGLEtBVE4sVUFBRyxJQUFJLENBQUMsS0FBSyxTQUFHLEtBQUssQ0FBRSxDQVVkLENBQ2pCLEVBaEJrRCxDQWdCbEQsQ0FDRixDQUNGLENBQUMsSUFDVyxJQUNiLEtBQ0ssSUFDSyxDQUNyQixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgeyB1c2VNdWx0aXBsZVNlbGVjdGlvbiwgdXNlQ29tYm9ib3ggfSBmcm9tICdkb3duc2hpZnQnO1xuaW1wb3J0IERvd25JY29uIGZyb20gJ2Fzc2V0cy9pY29ucy9pYy1hcnJvdy1kb3duLnN2Zyc7XG5pbXBvcnQgU2VhcmNoSWNvbiBmcm9tICdhc3NldHMvaWNvbnMvaWMtc2VhcmNoLnN2Zyc7XG5pbXBvcnQgRGVsZXRlSWNvbiBmcm9tICdhc3NldHMvaWNvbnMvaWMtZGVsZXRlLnN2Zyc7XG5pbXBvcnQgeyB1c2VDbGlja0FuZFRvdWNoQXdheSB9IGZyb20gJy4uLy4uL2hvb2tzL3VzZS1jbGljay1hbmQtdG91Y2gtYXdheSc7XG5pbXBvcnQgRmxleFJvdyBmcm9tICcuLi9mbGV4LXJvdy9mbGV4LXJvdyc7XG5pbXBvcnQgRmxleENvbHVtbiBmcm9tICcuLi9mbGV4LWNvbHVtbi9mbGV4LWNvbHVtbic7XG5pbXBvcnQgQm9keVRleHQgZnJvbSAnLi4vYm9keS10ZXh0L2JvZHktdGV4dCc7XG5pbXBvcnQgeyBCYXNlUHJvcHMgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5pbXBvcnQgU3ZnSWNvbiBmcm9tICcuLi9zdmctaWNvbi9zdmctaWNvbic7XG5pbXBvcnQgSW5wdXQgZnJvbSAnLi4vaW5wdXQvaW5wdXQnO1xuXG5jb25zdCBEcm9wZG93bkNvbnRhaW5lciA9IHN0eWxlZC5kaXY8eyBkaXNhYmxlZD86IGJvb2xlYW4gfT4oXG4gICh7IHRoZW1lLCBkaXNhYmxlZCB9KSA9PiAoe1xuICAgIG91dGxpbmU6ICdub25lJyxcblxuICAgIC4uLihkaXNhYmxlZCAmJiB7XG4gICAgICBvcGFjaXR5OiAnMC41JyxcbiAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJyxcbiAgICB9KSxcbiAgfSlcbik7XG5cbmNvbnN0IE11bHRpU2VsZWN0Q29udGFpbmVyID0gc3R5bGVkKEZsZXhSb3cpPHsgaXNPcGVuOiBib29sZWFuIH0+KFxuICAoeyB0aGVtZSB9KSA9PiAoe1xuICAgIGJvcmRlclJhZGl1czogdGhlbWUuYm9yZGVyUmFkaXVzLmJhc2UsXG4gICAgcGFkZGluZzogJzhweCcsXG4gICAgYmFja2dyb3VuZDogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5maWxsU2Vjb25kYXJ5LFxuICAgICc6aG92ZXIsIDphY3RpdmUnOiB7XG4gICAgICBzdmc6IHtcbiAgICAgICAgY29sb3I6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuZmlsbFByaW1hcnlSZWQsXG4gICAgICB9LFxuICAgIH0sXG4gIH0pXG4pO1xuXG5jb25zdCBJbnB1dENvbnRhaW5lciA9IHN0eWxlZChGbGV4Um93KSgoeyB0aGVtZSB9KSA9PiAoe1xuICB3aWR0aDogJzEwMCUnLFxufSkpO1xuXG5jb25zdCBTdHlsZWRJbnB1dCA9IHN0eWxlZChJbnB1dCkoKCkgPT4gKHtcbiAgd2lkdGg6ICcxMDAlJyxcbiAgYm9yZGVyOiAnbm9uZScsXG4gIGhlaWdodDogJzI0cHgnLFxuICAnPiBkaXYnOiB7XG4gICAgcGFkZGluZzogJzAgOHB4JyxcbiAgfSxcbn0pKTtcblxuY29uc3QgRHJvcGRvd25JY29uV3JhcHBlciA9IHN0eWxlZChGbGV4Um93KSgoeyB0aGVtZSB9KSA9PiAoe1xuICBwYWRkaW5nUmlnaHQ6ICc4cHgnLFxuICBtYXJnaW5MZWZ0OiAnOHB4Jyxcbn0pKTtcblxuY29uc3QgQXJyb3dTdmdJY29uID0gc3R5bGVkKFN2Z0ljb24pKCh7IHRoZW1lIH0pID0+ICh7XG4gIHBhdGg6IHtcbiAgICBmaWxsOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmNvbnRlbnRQcmltYXJ5LFxuICB9LFxufSkpO1xuXG5jb25zdCBDbGVhclN2Z0ljb24gPSBzdHlsZWQoU3ZnSWNvbikoKHsgdGhlbWUgfSkgPT4gKHtcbiAgcGF0aDoge1xuICAgIHN0cm9rZTogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5jb250ZW50UHJpbWFyeSxcbiAgfSxcbn0pKTtcblxuY29uc3QgQ2hpcEl0ZW1Db250YWluZXIgPSBzdHlsZWQuc3BhbigoeyB0aGVtZSB9KSA9PiAoe1xuICBib3JkZXJSYWRpdXM6IHRoZW1lLmJvcmRlclJhZGl1cy5iYXNlLFxuICBjdXJzb3I6ICdwb2ludGVyJyxcbiAgcGFkZGluZzogJzJweCA4cHgnLFxuICBiYWNrZ3JvdW5kOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmZpbGxUZXJ0cmlhcnksXG4gIGNvbG9yOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmNvbnRlbnRQcmltYXJ5LFxuICB3b3JkQnJlYWs6ICdicmVhay13b3JkJyxcbn0pKTtcblxuY29uc3QgSXRlbXNDb250YWluZXIgPSBzdHlsZWQuZGl2PHsgaXNPcGVuOiBib29sZWFuIH0+KCh7IHRoZW1lLCBpc09wZW4gfSkgPT4gKHtcbiAgZGlzcGxheTogaXNPcGVuID8gJ2luaGVyaXQnIDogJ25vbmUnLFxuICBtYXJnaW5Ub3A6IDQsXG4gIGJvcmRlclJhZGl1czogdGhlbWUuYm9yZGVyUmFkaXVzLmJhc2UsXG4gIGJhY2tncm91bmQ6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuZmlsbFNlY29uZGFyeSxcbiAgbWF4SGVpZ2h0OiAnMjUwcHgnLFxuICBvdmVyZmxvd1k6ICdzY3JvbGwnLFxufSkpO1xuXG5jb25zdCBJdGVtc0NvbnRhaW5lckVtcHR5ID0gc3R5bGVkKEZsZXhSb3cpKCh7IHRoZW1lIH0pID0+ICh7XG4gIHBhZGRpbmc6ICczMnB4IDE2cHgnLFxuICBwb2ludGVyRXZlbnRzOiAnbm9uZScsXG4gIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJyxcbn0pKTtcblxuY29uc3QgSXRlbUNvbnRhaW5lciA9IHN0eWxlZChGbGV4Um93KSgoeyB0aGVtZSB9KSA9PiAoe1xuICBjdXJzb3I6ICdwb2ludGVyJyxcbiAgbWluSGVpZ2h0OiAzNixcbiAgcGFkZGluZzogJzhweCAxNnB4JyxcbiAgd29yZEJyZWFrOiAnYnJlYWstd29yZCcsXG4gICc6aG92ZXIsIDphY3RpdmUnOiB7XG4gICAgYmFja2dyb3VuZDogdGhlbWUuc3R5bGVndWlkZUNvbG9ycy5maWxsU2Vjb25kYXJ5Qmx1ZUhvdmVyLFxuICAgIGZvbnRXZWlnaHQ6IDYwMCxcbiAgfSxcbn0pKTtcblxuY29uc3QgTXVsdGlTZWxlY3REZWxldGVJY29uID0gc3R5bGVkKFN2Z0ljb24pKCh7IHRoZW1lIH0pID0+ICh7XG4gIHBhdGg6IHtcbiAgICBzdHJva2U6IHRoZW1lLnN0eWxlZ3VpZGVDb2xvcnMuY29udGVudEJsdWUsXG4gIH0sXG4gICc6aG92ZXIsIDphY3RpdmUnOiB7XG4gICAgcGF0aDoge1xuICAgICAgc3Ryb2tlOiB0aGVtZS5zdHlsZWd1aWRlQ29sb3JzLmNvbnRlbnRSZWQsXG4gICAgfSxcbiAgfSxcbn0pKTtcblxuZXhwb3J0IHR5cGUgTXVsdGlTZWxlY3REcm9wZG93blZhbHVlID0ge1xuICBsYWJlbDogc3RyaW5nO1xuICBjaGlwTGFiZWw/OiBzdHJpbmc7XG4gIHZhbHVlOiBhbnk7XG59O1xuXG5leHBvcnQgdHlwZSBNdWx0aVNlbGVjdERyb3Bkb3duRXZlbnRWYWx1ZSA9IHtcbiAgdGFyZ2V0OiB7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB2YWx1ZTogTXVsdGlTZWxlY3REcm9wZG93blZhbHVlIHwgbnVsbDtcbiAgfTtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTXVsdGlTZWxlY3RJbnB1dFByb3BzIGV4dGVuZHMgQmFzZVByb3BzIHtcbiAgdmFsdWU/OiBNdWx0aVNlbGVjdERyb3Bkb3duVmFsdWVbXTtcbiAgaXRlbXM6IE11bHRpU2VsZWN0RHJvcGRvd25WYWx1ZVtdO1xuICBsYWJlbD86IHN0cmluZyB8IEpTWC5FbGVtZW50O1xuICBwbGFjZWhvbGRlcj86IHN0cmluZztcbiAgZGlzYWJsZWQ/OiBib29sZWFuO1xuICBvbkFkZEl0ZW0/OiAoZXY6IE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlKSA9PiB2b2lkO1xuICBvblNlbGVjdEl0ZW0/OiAoZXY6IE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlKSA9PiB2b2lkO1xuICBvblJlbW92ZUl0ZW0/OiAoZXY6IE11bHRpU2VsZWN0RHJvcGRvd25FdmVudFZhbHVlKSA9PiB2b2lkO1xuICBvbkNoYW5nZUlucHV0PzogKHZhbHVlOiBzdHJpbmcpID0+IHZvaWQ7XG59XG5cbmNvbnN0IGdldENoYW5nZUV2ZW50ID0gKHZhbHVlOiBhbnkpOiBNdWx0aVNlbGVjdERyb3Bkb3duRXZlbnRWYWx1ZSA9PiB7XG4gIHJldHVybiB7XG4gICAgdGFyZ2V0OiB7XG4gICAgICBuYW1lOiB1bmRlZmluZWQsXG4gICAgICB2YWx1ZSxcbiAgICB9LFxuICB9O1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIE11bHRpU2VsZWN0SW5wdXQocHJvcHM6IE11bHRpU2VsZWN0SW5wdXRQcm9wcykge1xuICBjb25zdCB7XG4gICAgaXRlbXMsXG4gICAgdmFsdWUsXG4gICAgbGFiZWwsXG4gICAgcGxhY2Vob2xkZXIsXG4gICAgZGlzYWJsZWQgPSBmYWxzZSxcbiAgICBvblNlbGVjdEl0ZW0sXG4gICAgb25BZGRJdGVtLFxuICAgIG9uUmVtb3ZlSXRlbSxcbiAgICBvbkNoYW5nZUlucHV0LFxuICB9ID0gcHJvcHM7XG4gIGNvbnN0IFtpbnB1dFZhbHVlLCBzZXRJbnB1dFZhbHVlXSA9IHVzZVN0YXRlPHN0cmluZz4oJycpO1xuXG4gIGNvbnN0IHtcbiAgICBnZXRTZWxlY3RlZEl0ZW1Qcm9wcyxcbiAgICBnZXREcm9wZG93blByb3BzLFxuICAgIGFkZFNlbGVjdGVkSXRlbSxcbiAgICByZW1vdmVTZWxlY3RlZEl0ZW0sXG4gICAgc2VsZWN0ZWRJdGVtcyxcbiAgICBzZXRTZWxlY3RlZEl0ZW1zLFxuICAgIHJlc2V0LFxuICB9ID0gdXNlTXVsdGlwbGVTZWxlY3Rpb248TXVsdGlTZWxlY3REcm9wZG93blZhbHVlPih7XG4gICAgaW5pdGlhbFNlbGVjdGVkSXRlbXM6IHZhbHVlLFxuICAgIG9uU2VsZWN0ZWRJdGVtc0NoYW5nZTogKGNoYW5nZXMpID0+IHtcbiAgICAgIG9uU2VsZWN0SXRlbSAmJiBvblNlbGVjdEl0ZW0oZ2V0Q2hhbmdlRXZlbnQoY2hhbmdlcy5zZWxlY3RlZEl0ZW1zKSk7XG4gICAgfSxcbiAgfSk7XG5cbiAgY29uc3QgaW5wdXRWYWx1ZUl0ZW0gPVxuICAgIGlucHV0VmFsdWU/Lmxlbmd0aCA+PSAzXG4gICAgICA/IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogaW5wdXRWYWx1ZSxcbiAgICAgICAgICAgIGxhYmVsOiBpbnB1dFZhbHVlLFxuICAgICAgICAgICAgdmFsdWU6IGlucHV0VmFsdWUsXG4gICAgICAgICAgICBjaGlwTGFiZWw6IGlucHV0VmFsdWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgXVxuICAgICAgOiBbXTtcblxuICBjb25zdCBpdGVtc1dpdGhDdXN0b21JbnB1dFZhbHVlID0gWy4uLmlucHV0VmFsdWVJdGVtLCAuLi5pdGVtc107XG5cbiAgY29uc3Qge1xuICAgIGlzT3BlbixcbiAgICBnZXRUb2dnbGVCdXR0b25Qcm9wcyxcbiAgICBnZXRMYWJlbFByb3BzLFxuICAgIGdldE1lbnVQcm9wcyxcbiAgICBnZXRJbnB1dFByb3BzLFxuICAgIGdldEl0ZW1Qcm9wcyxcbiAgICBvcGVuTWVudSxcbiAgfSA9IHVzZUNvbWJvYm94PE11bHRpU2VsZWN0RHJvcGRvd25WYWx1ZT4oe1xuICAgIGlucHV0VmFsdWUsXG4gICAgaXRlbXM6IGl0ZW1zV2l0aEN1c3RvbUlucHV0VmFsdWUsXG4gICAgb25TdGF0ZUNoYW5nZTogKHsgaW5wdXRWYWx1ZSwgdHlwZSwgc2VsZWN0ZWRJdGVtOiBuZXdTZWxlY3RlZEl0ZW0gfSkgPT4ge1xuICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgIGNhc2UgdXNlQ29tYm9ib3guc3RhdGVDaGFuZ2VUeXBlcy5JbnB1dENoYW5nZTpcbiAgICAgICAgICBzZXRJbnB1dFZhbHVlKGlucHV0VmFsdWUgfHwgJycpO1xuICAgICAgICAgIG9uQ2hhbmdlSW5wdXQgJiYgb25DaGFuZ2VJbnB1dChpbnB1dFZhbHVlIHx8ICcnKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIHVzZUNvbWJvYm94LnN0YXRlQ2hhbmdlVHlwZXMuSW5wdXRLZXlEb3duRW50ZXI6XG4gICAgICAgIGNhc2UgdXNlQ29tYm9ib3guc3RhdGVDaGFuZ2VUeXBlcy5JdGVtQ2xpY2s6XG4gICAgICAgIGNhc2UgdXNlQ29tYm9ib3guc3RhdGVDaGFuZ2VUeXBlcy5JbnB1dEJsdXI6XG4gICAgICAgICAgY29uc3QgaXNBbHJlYWR5U2VsZWN0ZWQgPSBzZWxlY3RlZEl0ZW1zLnNvbWUoXG4gICAgICAgICAgICAoaSkgPT4gaS52YWx1ZSA9PT0gbmV3U2VsZWN0ZWRJdGVtPy52YWx1ZVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAobmV3U2VsZWN0ZWRJdGVtKSB7XG4gICAgICAgICAgICBpZiAoaXNBbHJlYWR5U2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRJdGVtcyhcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1zLmZpbHRlcigoaSkgPT4gaS52YWx1ZSAhPT0gbmV3U2VsZWN0ZWRJdGVtLnZhbHVlKVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICBvblJlbW92ZUl0ZW0gJiYgb25SZW1vdmVJdGVtKGdldENoYW5nZUV2ZW50KG5ld1NlbGVjdGVkSXRlbSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYWRkU2VsZWN0ZWRJdGVtKG5ld1NlbGVjdGVkSXRlbSk7XG4gICAgICAgICAgICAgIG9uQWRkSXRlbSAmJiBvbkFkZEl0ZW0oZ2V0Q2hhbmdlRXZlbnQobmV3U2VsZWN0ZWRJdGVtKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHVzZUNvbWJvYm94LnN0YXRlQ2hhbmdlVHlwZXMuRnVuY3Rpb25DbG9zZU1lbnU6XG4gICAgICAgICAgaGFuZGxlQ2xlYXJJbnB1dCgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0sXG4gICAgc3RhdGVSZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbkFuZENoYW5nZXMpID0+IHtcbiAgICAgIGNvbnN0IHsgY2hhbmdlcywgdHlwZSB9ID0gYWN0aW9uQW5kQ2hhbmdlcztcbiAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICBjYXNlIHVzZUNvbWJvYm94LnN0YXRlQ2hhbmdlVHlwZXMuSW5wdXRLZXlEb3duRW50ZXI6XG4gICAgICAgIGNhc2UgdXNlQ29tYm9ib3guc3RhdGVDaGFuZ2VUeXBlcy5JdGVtQ2xpY2s6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLmNoYW5nZXMsXG4gICAgICAgICAgICBpc09wZW46IHN0YXRlLmlzT3BlbiwgLy8ga2VlcCB0aGUgbWVudSBvcGVuIGFmdGVyIHNlbGVjdGlvbi5cbiAgICAgICAgICB9O1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHJldHVybiBjaGFuZ2VzO1xuICAgICAgfVxuICAgIH0sXG4gIH0pO1xuXG4gIGNvbnN0IHsgcmVmOiBvdXRlckNsaWNrUmVmIH0gPSB1c2VDbGlja0FuZFRvdWNoQXdheSh7XG4gICAgY2FsbGJhY2s6ICgpID0+IHtcbiAgICAgIGlmIChpc09wZW4pIHtcbiAgICAgICAgaGFuZGxlQ2xlYXJJbnB1dCgpO1xuICAgICAgfVxuICAgIH0sXG4gIH0pO1xuXG4gIC8vQWxpZ24gcmVzZXR0aW5nIHNlbGVjdGVkIHZhbHVlcyBpZiB0aGV5IHdlcmUgcmVzZXQgaW4gcGFyZW50XG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKCF2YWx1ZSB8fCB2YWx1ZS5sZW5ndGggPCAxKSB7XG4gICAgICByZXNldCgpO1xuICAgIH1cbiAgfSwgW3ZhbHVlXSk7XG5cbiAgY29uc3QgaGFuZGxlQ2xlYXJJbnB1dCA9ICgpID0+IHtcbiAgICBzZXRJbnB1dFZhbHVlKCcnKTtcbiAgICBvbkNoYW5nZUlucHV0ICYmIG9uQ2hhbmdlSW5wdXQoJycpO1xuICB9O1xuXG4gIGNvbnN0IGhhbmRsZUNsZWFyQWxsID0gKCkgPT4ge1xuICAgIGhhbmRsZUNsZWFySW5wdXQoKTtcbiAgICBvblNlbGVjdEl0ZW0gJiYgb25TZWxlY3RJdGVtKGdldENoYW5nZUV2ZW50KG51bGwpKTtcbiAgICByZXNldCgpO1xuICB9O1xuXG4gIGNvbnN0IHNob3dJbnB1dCA9IGlzT3BlbiB8fCBzZWxlY3RlZEl0ZW1zLmxlbmd0aCA9PT0gMDtcblxuICByZXR1cm4gKFxuICAgIDxEcm9wZG93bkNvbnRhaW5lciBkaXNhYmxlZD17ZGlzYWJsZWR9IHJlZj17b3V0ZXJDbGlja1JlZn0+XG4gICAgICA8RmxleENvbHVtbiBpdGVtc1NwYWNpbmc9ezR9PlxuICAgICAgICB7bGFiZWwgJiYgKFxuICAgICAgICAgIDxCb2R5VGV4dCBsaW5lSGVpZ2h0PXsneHMnfSB7Li4uZ2V0TGFiZWxQcm9wcygpfSBzaXplPXsxfT5cbiAgICAgICAgICAgIHtsYWJlbH1cbiAgICAgICAgICA8L0JvZHlUZXh0PlxuICAgICAgICApfVxuICAgICAgICA8ZGl2PlxuICAgICAgICAgIDxNdWx0aVNlbGVjdENvbnRhaW5lclxuICAgICAgICAgICAgaXNPcGVuPXtpc09wZW59XG4gICAgICAgICAgICBhbGlnbj1cImNlbnRlclwiXG4gICAgICAgICAgICBqdXN0aWZ5PVwic3BhY2UtYmV0d2VlblwiXG4gICAgICAgICAgICB7Li4uZ2V0VG9nZ2xlQnV0dG9uUHJvcHMoXG4gICAgICAgICAgICAgIGdldERyb3Bkb3duUHJvcHMoeyBwcmV2ZW50S2V5QWN0aW9uOiBpc09wZW4gfSlcbiAgICAgICAgICAgICl9XG4gICAgICAgICAgPlxuICAgICAgICAgICAgPElucHV0Q29udGFpbmVyIGdhcD17OH0gd3JhcD17J3dyYXAnfT5cbiAgICAgICAgICAgICAge3NlbGVjdGVkSXRlbXMubWFwKChzZWxlY3RlZEl0ZW0sIGluZGV4KSA9PiAoXG4gICAgICAgICAgICAgICAgPENoaXBJdGVtQ29udGFpbmVyXG4gICAgICAgICAgICAgICAgICBrZXk9e2BzZWxlY3RlZC1pdGVtLSR7aW5kZXh9YH1cbiAgICAgICAgICAgICAgICAgIHsuLi5nZXRTZWxlY3RlZEl0ZW1Qcm9wcyh7IHNlbGVjdGVkSXRlbSwgaW5kZXggfSl9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgPEJvZHlUZXh0XG4gICAgICAgICAgICAgICAgICAgIGxpbmVIZWlnaHQ9eyd4cyd9XG4gICAgICAgICAgICAgICAgICAgIHNpemU9ezN9XG4gICAgICAgICAgICAgICAgICAgIHZhcmlhdGlvbj17c2VsZWN0ZWRJdGVtID8gJ2luaGVyaXQnIDogJ2RhcmtHcmF5J31cbiAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgPEZsZXhSb3cgYWxpZ249eydjZW50ZXInfSBnYXA9ezR9PlxuICAgICAgICAgICAgICAgICAgICAgIHtzZWxlY3RlZEl0ZW0/LmNoaXBMYWJlbCB8fCBzZWxlY3RlZEl0ZW0/LmxhYmVsfVxuICAgICAgICAgICAgICAgICAgICAgIDxNdWx0aVNlbGVjdERlbGV0ZUljb25cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eyhldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlU2VsZWN0ZWRJdGVtKHNlbGVjdGVkSXRlbSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT17MTR9XG4gICAgICAgICAgICAgICAgICAgICAgICBzcmM9e0RlbGV0ZUljb259XG4gICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgPC9GbGV4Um93PlxuICAgICAgICAgICAgICAgICAgPC9Cb2R5VGV4dD5cbiAgICAgICAgICAgICAgICA8L0NoaXBJdGVtQ29udGFpbmVyPlxuICAgICAgICAgICAgICApKX1cbiAgICAgICAgICAgICAge3Nob3dJbnB1dCA/IChcbiAgICAgICAgICAgICAgICA8U3R5bGVkSW5wdXRcbiAgICAgICAgICAgICAgICAgIHsuLi5nZXRJbnB1dFByb3BzKFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlucHV0VmFsdWUgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQsXG4gICAgICAgICAgICAgICAgICAgICAgb25Gb2N1cygpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5NZW51KCk7XG4gICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgeyBzdXBwcmVzc1JlZkVycm9yOiB0cnVlIH1cbiAgICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgICAgICBwcmVmaXhJY29uPXs8U3ZnSWNvbiBzcmM9e1NlYXJjaEljb259IC8+fVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICkgOiBudWxsfVxuICAgICAgICAgICAgPC9JbnB1dENvbnRhaW5lcj5cbiAgICAgICAgICAgIDxEcm9wZG93bkljb25XcmFwcGVyPlxuICAgICAgICAgICAgICB7ISFzZWxlY3RlZEl0ZW1zLmxlbmd0aCAmJiAoXG4gICAgICAgICAgICAgICAgPENsZWFyU3ZnSWNvblxuICAgICAgICAgICAgICAgICAgc3JjPXtEZWxldGVJY29ufVxuICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlQ2xlYXJBbGx9XG4gICAgICAgICAgICAgICAgICBtYXJnaW5SaWdodFxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgIDxBcnJvd1N2Z0ljb24gc3JjPXtEb3duSWNvbn0gcm90YXRlPXtpc09wZW59IC8+XG4gICAgICAgICAgICA8L0Ryb3Bkb3duSWNvbldyYXBwZXI+XG4gICAgICAgICAgPC9NdWx0aVNlbGVjdENvbnRhaW5lcj5cbiAgICAgICAgICA8SXRlbXNDb250YWluZXIgey4uLmdldE1lbnVQcm9wcygpfSBpc09wZW49e2lzT3Blbn0+XG4gICAgICAgICAgICB7aXNPcGVuICYmXG4gICAgICAgICAgICAgICghKFxuICAgICAgICAgICAgICAgIGl0ZW1zV2l0aEN1c3RvbUlucHV0VmFsdWUgJiYgaXRlbXNXaXRoQ3VzdG9tSW5wdXRWYWx1ZS5sZW5ndGhcbiAgICAgICAgICAgICAgKSA/IChcbiAgICAgICAgICAgICAgICA8SXRlbXNDb250YWluZXJFbXB0eT5cbiAgICAgICAgICAgICAgICAgIDxCb2R5VGV4dCBzaXplPXszfSBsaW5lSGVpZ2h0PXsneHMnfSBzY2FsZT17J3hzJ30+XG4gICAgICAgICAgICAgICAgICAgIE5vIGl0ZW1zIGZvdW5kXG4gICAgICAgICAgICAgICAgICA8L0JvZHlUZXh0PlxuICAgICAgICAgICAgICAgIDwvSXRlbXNDb250YWluZXJFbXB0eT5cbiAgICAgICAgICAgICAgKSA6IChcbiAgICAgICAgICAgICAgICBpdGVtc1dpdGhDdXN0b21JbnB1dFZhbHVlLm1hcChcbiAgICAgICAgICAgICAgICAgIChpdGVtOiBNdWx0aVNlbGVjdERyb3Bkb3duVmFsdWUsIGluZGV4OiBudW1iZXIpID0+IChcbiAgICAgICAgICAgICAgICAgICAgPEl0ZW1Db250YWluZXJcbiAgICAgICAgICAgICAgICAgICAgICBhbGlnbj1cImNlbnRlclwiXG4gICAgICAgICAgICAgICAgICAgICAganVzdGlmeT1cInNwYWNlLWJldHdlZW5cIlxuICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zU3BhY2luZz17MTB9XG4gICAgICAgICAgICAgICAgICAgICAga2V5PXtgJHtpdGVtLnZhbHVlfSR7aW5kZXh9YH1cbiAgICAgICAgICAgICAgICAgICAgICB7Li4uZ2V0SXRlbVByb3BzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICdhcmlhLXNlbGVjdGVkJzogc2VsZWN0ZWRJdGVtcy5pbmNsdWRlcyhpdGVtKSxcbiAgICAgICAgICAgICAgICAgICAgICB9KX1cbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgIDxCb2R5VGV4dCBzaXplPXszfSBsaW5lSGVpZ2h0PXsneHMnfSBzY2FsZT17J3hzJ30+XG4gICAgICAgICAgICAgICAgICAgICAgICB7aXRlbS5sYWJlbH1cbiAgICAgICAgICAgICAgICAgICAgICA8L0JvZHlUZXh0PlxuICAgICAgICAgICAgICAgICAgICA8L0l0ZW1Db250YWluZXI+XG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApKX1cbiAgICAgICAgICA8L0l0ZW1zQ29udGFpbmVyPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvRmxleENvbHVtbj5cbiAgICA8L0Ryb3Bkb3duQ29udGFpbmVyPlxuICApO1xufVxuIl19