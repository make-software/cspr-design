name: publish npm package

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Extract branch name
        id: extract_branch
        run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT

      - name: Extract version from package.json
        id: extract_version
        run: echo "version=$(cat package.json | jq '.version' | tr -d '\"')" >> $GITHUB_OUTPUT

      - name: Check branch name and get semver
        id: check_branch
        if: startsWith(steps.extract_branch.outputs.branch, 'rc-')
        run: |
          branch_name="${{ steps.extract_branch.outputs.branch }}"
          version=$(echo "$branch_name" | sed -n 's/rc-\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          echo "version=$version" >> $GITHUB_OUTPUT
          semver=$(echo "v$version")
          echo "semver=$semver" >> $GITHUB_OUTPUT

      - name: Compare branch name and version from package.json
        if: ${{ steps.check_branch.outputs.version != steps.extract_version.outputs.version }}
        run: echo "Versions do not match. Please check." && exit 1

      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org'

      #- name: Authenticate with GitHub Package Registry
      #  run: echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_REGITRY_TOKEN }}" > .npmrc

      - name: Install dependencies
        run: |
          git config --global url."https://${{ secrets.GH_CI_TOKEN }}:x-oauth-basic@github.com".insteadOf "ssh://git@github.com" 
          npm install

      - name: Build package
        run: npm run build:dist:vite

      - name: Publish to NPM Package Registry
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}